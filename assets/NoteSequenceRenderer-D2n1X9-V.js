import{i as vt,p as ft,T as gt,M as bt,s as Et}from"./audio-player-C8eAfouR.js";import{c as j}from"./vexflow-helper-BJ71SLUW.js";const yt=`<!-- src/tools/NoteSequenceRenderer/NoteSequenceRenderer.html -->

<div class="tool-section note-sequence-renderer-tool">
    <h3>音符序列渲染器</h3>
    <p>
        输入音符序列。用空格分隔表示旋律，直接连接表示和弦。使用 <code>/</code> 指定时值 (h, q, 8, 16, 32, 64) 和附点 (<code>d</code>)，用 <code>r</code> 或 <code>z</code> 表示休止符。
    </p>
    <div class="examples-section">
        <p>点击下面的示例可以填充到输入框：</p>
        <ul id="note-examples-list" class="examples-list">
            <li><span class="example-input" title="点击填充到输入框">C4/h D4/q r/8 E#4/16d Z/q C4E4G4/w</span> <small>(混合)</small></li>
            <li><span class="example-input" title="点击填充到输入框">G3B3D4/h r/h C5/q C5/q</span> <small>(和弦与休止)</small></li>
            <li><span class="example-input" title="点击填充到输入框">A4/8 B4/8 C5/8 D5/8 E5/q F5/q</span> <small>(旋律)</small></li>
        </ul>
    </div>

    <!-- 工具栏选项 -->
    <div class="score-options">
        <div class="option-group">
            <label for="clef-select">Clef:</label>
            <select id="clef-select">
                <option value="treble" selected>Treble</option>
                <option value="bass">Bass</option>
                <option value="alto">Alto</option>
                <option value="tenor">Tenor</option>
            </select>
        </div>
        <!-- **** 新增：调号选择 **** -->
        <div class="option-group">
            <label for="key-signature-select">Key Sig.:</label>
            <select id="key-signature-select">
                <option value="C" selected>C Maj / A min</option>
                <option value="G">G Maj / E min (1♯)</option>
                <option value="D">D Maj / B min (2♯)</option>
                <option value="A">A Maj / F♯ min (3♯)</option>
                <option value="E">E Maj / C♯ min (4♯)</option>
                <option value="B">B Maj / G♯ min (5♯)</option>
                <option value="F#">F♯ Maj / D♯ min (6♯)</option>
                <option value="C#">C♯ Maj / A♯ min (7♯)</option>
                <option value="F">F Maj / D min (1♭)</option>
                <option value="Bb">B♭ Maj / G min (2♭)</option>
                <option value="Eb">E♭ Maj / C min (3♭)</option>
                <option value="Ab">A♭ Maj / F min (4♭)</option>
                <option value="Db">D♭ Maj / B♭ min (5♭)</option>
                <option value="Gb">G♭ Maj / E♭ min (6♭)</option>
                <option value="Cb">C♭ Maj / A♭ min (7♭)</option>
                <!-- 可以添加更多不常用的调号或区分大小调 -->
            </select>
        </div>
        <!-- **** 结束新增 **** -->
        <div class="option-group">
            <label for="time-signature-select">Time Sig.:</label>
            <select id="time-signature-select">
                <option value="4/4" selected>4/4</option>
                <option value="C">C (Common Time)</option>
                <option value="3/4">3/4</option>
                <option value="2/4">2/4</option>
                <option value="6/8">6/8</option>
                <option value="C|">Cut Time (2/2)</option>
                <option value="free">Free Time</option>
            </select>
        </div>
    </div>

    <!-- 输入区域 -->
    <div class="note-input-area">
        <label for="note-input-textarea">输入音符:</label>
        <textarea id="note-input-textarea" rows="3" placeholder="在此输入或点击上方示例填充..."></textarea>
    </div>

    <!-- 按钮 -->
    <button id="render-notes-button">Render Score</button>

    <div></div>
    <!-- VexFlow 显示区域 -->
    <div id="note-sequence-display-area" class="vexflow-score-container" style="min-height: 150px;">
        <p>在此处将显示渲染的乐谱。</p>
    </div>
    
    <div class="playback-export-controls input-section">
        <h4>播放与导出</h4>
        <div class="option-group">
            <!-- Keep original class for JS, add new style class -->
            <button class="play-button button-primary">播放</button> 
            <button class="stop-button button-secondary">停止</button> 
        </div>
        <div class="option-group">
            <!-- Keep original ID for JS -->
            <label for="bpm-input">BPM:</label>
            <input type="number" id="bpm-input" value="120" min="30" max="300" style="width: 80px;">
        </div>
        <div class="option-group">
            <!-- Keep original ID for JS, update class for styling -->
            <button id="export-midi-button" class="button-secondary">导出 MIDI</button> 
        </div>
    </div>
</div>
`;function mt(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var $,at;function xt(){if(at)return $;at=1;var i={VERSION:"3.1.1",HEADER_CHUNK_TYPE:[77,84,104,100],HEADER_CHUNK_LENGTH:[0,0,0,6],HEADER_CHUNK_FORMAT0:[0,0],HEADER_CHUNK_FORMAT1:[0,1],HEADER_CHUNK_DIVISION:[0,128],TRACK_CHUNK_TYPE:[77,84,114,107],META_EVENT_ID:255,META_SMTPE_OFFSET:84},a=(e,t)=>Array(Math.abs(t)+1).join(e);function o(e){return e!==null&&typeof e=="object"&&typeof e.name=="string"}function d(e){return e!==null&&typeof e=="object"&&typeof e.step=="number"&&typeof e.alt=="number"}var p=[0,2,4,-1,1,3,5],h=p.map(e=>Math.floor(e*7/12));function E(e){const{step:t,alt:n,oct:r,dir:s=1}=e,l=p[t]+7*n;if(r===void 0)return[s*l];const u=r-h[t]-4*n;return[s*l,s*u]}var T={empty:!0,name:"",pc:"",acc:""},v=new Map,f=e=>"CDEFGAB".charAt(e),b=e=>e<0?a("b",-e):a("#",e),y=e=>e[0]==="b"?-e.length:e.length;function m(e){const t=JSON.stringify(e),n=v.get(t);if(n)return n;const r=typeof e=="string"?D(e):d(e)?m(S(e)):o(e)?m(e.name):T;return v.set(t,r),r}var x=/^([a-gA-G]?)(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)$/;function k(e){const t=x.exec(e);return[t[1].toUpperCase(),t[2].replace(/x/g,"##"),t[3],t[4]]}var C=(e,t)=>(e%t+t)%t,w=[0,2,4,5,7,9,11];function D(e){const t=k(e);if(t[0]===""||t[3]!=="")return T;const n=t[0],r=t[1],s=t[2],l=(n.charCodeAt(0)+3)%7,u=y(r),g=s.length?+s:void 0,N=E({step:l,alt:u,oct:g}),P=n+r+s,U=n+r,R=(w[l]+u+120)%12,M=g===void 0?C(w[l]+u,12)-12*99:w[l]+u+12*(g+1),O=M>=0&&M<=127?M:null,pt=g===void 0?null:Math.pow(2,(M-69)/12)*440;return{empty:!1,acc:r,alt:u,chroma:R,coord:N,freq:pt,height:M,letter:n,midi:O,name:P,oct:g,pc:U,step:l}}function S(e){const{step:t,alt:n,oct:r}=e,s=f(t);if(!s)return"";const l=s+b(n);return r||r===0?l+r:l}function I(e){return+e>=0&&+e<=127}function L(e){if(I(e))return+e;const t=m(e);return t.empty?null:t.midi}var c=function(){function e(){}return e.version=function(){return i.VERSION},e.stringToBytes=function(t){return t.split("").map(function(n){return n.charCodeAt(0)})},e.isNumeric=function(t){return!isNaN(parseFloat(t))&&isFinite(t)},e.getPitch=function(t,n){return n===void 0&&(n="C4"),60-L(n)+L(t)},e.numberToVariableLength=function(t){t=Math.round(t);for(var n=t&127;t=t>>7;)n<<=8,n|=t&127|128;for(var r=[];r.push(n&255),n&128;)n>>=8;return r},e.stringByteCount=function(t){return encodeURI(t).split(/%..|./).length-1},e.numberFromBytes=function(t){var n="",r;return t.forEach(function(s){r=s.toString(16),r.length==1&&(r="0"+r),n+=r}),parseInt(n,16)},e.numberToBytes=function(t,n){n=n||1;var r=t.toString(16);r.length&1&&(r="0"+r);var s=r.match(/.{2}/g),l=s.map(function(u){return parseInt(u,16)});if(l.length<n)for(;n-l.length>0;)l.unshift(0);return l},e.toArray=function(t){return Array.isArray(t)?t:[t]},e.convertVelocity=function(t){return t=t>100?100:t,Math.round(t/100*127)},e.getTickDuration=function(t){if(Array.isArray(t))return t.map(function(l){return e.getTickDuration(l)}).reduce(function(l,u){return l+u},0);if(t=t.toString(),t.toLowerCase().charAt(0)==="t"){var n=parseInt(t.substring(1));if(isNaN(n)||n<0)throw new Error(t+" is not a valid duration.");return n}var r=e.numberFromBytes(i.HEADER_CHUNK_DIVISION),s=r*e.getDurationMultiplier(t);return e.getRoundedIfClose(s)},e.getRoundedIfClose=function(t){var n=Math.round(t);return Math.abs(n-t)<1e-6?n:t},e.getPrecisionLoss=function(t){var n=Math.round(t);return n-t},e.getDurationMultiplier=function(t){if(t==="0")return 0;var n=t.match(/^(?<dotted>d+)?(?<base>\d+)(?:t(?<tuplet>\d*))?/);if(n){var r=Number(n.groups.base),s=r===1||(r&r-1)===0;if(s){var l=r/4,u=1/l,g=n.groups,N=g.dotted,P=g.tuplet;if(N){var U=N.length,R=Math.pow(2,U);u=u+u*((R-1)/R)}if(typeof P=="string"){var M=u*2,O=Number(P||"3");u=M/O}return u}}throw new Error(t+" is not a valid duration.")},e}(),A=function(){function e(t){this.channel=t.channel-1||0,this.controllerValue=t.controllerValue,this.controllerNumber=t.controllerNumber,this.delta=t.delta||0,this.name="ControllerChangeEvent",this.status=176,this.data=c.numberToVariableLength(t.delta).concat(this.status|this.channel,this.controllerNumber,this.controllerValue)}return e}(),z=function(){function e(t){this.delta=t.delta||0,this.name="CopyrightEvent",this.text=t.text,this.type=2;var n=c.stringToBytes(this.text);this.data=c.numberToVariableLength(this.delta).concat(i.META_EVENT_ID,this.type,c.numberToVariableLength(n.length),n)}return e}(),J=function(){function e(t){this.delta=t.delta||0,this.name="CuePointEvent",this.text=t.text,this.type=7;var n=c.stringToBytes(this.text);this.data=c.numberToVariableLength(this.delta).concat(i.META_EVENT_ID,this.type,c.numberToVariableLength(n.length),n)}return e}(),q=function(){function e(t){this.delta=(t==null?void 0:t.delta)||0,this.name="EndTrackEvent",this.type=[47,0],this.data=c.numberToVariableLength(this.delta).concat(i.META_EVENT_ID,this.type)}return e}(),Y=function(){function e(t){this.delta=t.delta||0,this.name="InstrumentNameEvent",this.text=t.text,this.type=4;var n=c.stringToBytes(this.text);this.data=c.numberToVariableLength(this.delta).concat(i.META_EVENT_ID,this.type,c.numberToVariableLength(n.length),n)}return e}(),X=function(){function e(t,n){this.name="KeySignatureEvent",this.type=89;var r=n||0;if(t=t||0,typeof n>"u"){var s=[["Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#"],["ab","eb","bb","f","c","g","d","a","e","b","f#","c#","g#","d#","a#"]],l=t.length,u=t||"C";if(t[0]===t[0].toLowerCase()&&(r=1),l>1)switch(t.charAt(l-1)){case"m":r=1,u=t.charAt(0).toLowerCase(),u=u.concat(t.substring(1,l-1));break;case"-":r=1,u=t.charAt(0).toLowerCase(),u=u.concat(t.substring(1,l-1));break;case"M":r=0,u=t.charAt(0).toUpperCase(),u=u.concat(t.substring(1,l-1));break;case"+":r=0,u=t.charAt(0).toUpperCase(),u=u.concat(t.substring(1,l-1));break}var g=s[r].indexOf(u);t=g===-1?0:g-7}this.data=c.numberToVariableLength(0).concat(i.META_EVENT_ID,this.type,[2],c.numberToBytes(t,1),c.numberToBytes(r,1))}return e}(),Z=function(){function e(t){this.delta=t.delta||0,this.name="LyricEvent",this.text=t.text,this.type=5;var n=c.stringToBytes(this.text);this.data=c.numberToVariableLength(this.delta).concat(i.META_EVENT_ID,this.type,c.numberToVariableLength(n.length),n)}return e}(),Q=function(){function e(t){this.delta=t.delta||0,this.name="MarkerEvent",this.text=t.text,this.type=6;var n=c.stringToBytes(this.text);this.data=c.numberToVariableLength(this.delta).concat(i.META_EVENT_ID,this.type,c.numberToVariableLength(n.length),n)}return e}(),B=function(){function e(t){this.name="NoteOnEvent",this.channel=t.channel||1,this.pitch=t.pitch,this.wait=t.wait||0,this.velocity=t.velocity||50,this.tick=t.tick||null,this.delta=null,this.data=t.data,this.status=144}return e.prototype.buildData=function(t,n,r){return r===void 0&&(r={}),this.data=[],this.tick?(this.tick=c.getRoundedIfClose(this.tick),t.tickPointer==0&&(this.delta=this.tick)):(this.delta=c.getTickDuration(this.wait),this.tick=c.getRoundedIfClose(t.tickPointer+this.delta)),this.deltaWithPrecisionCorrection=c.getRoundedIfClose(this.delta-n),this.data=c.numberToVariableLength(this.deltaWithPrecisionCorrection).concat(this.status|this.channel-1,c.getPitch(this.pitch,r.middleC),c.convertVelocity(this.velocity)),this},e}(),V=function(){function e(t){this.name="NoteOffEvent",this.channel=t.channel||1,this.pitch=t.pitch,this.velocity=t.velocity||50,this.tick=t.tick||null,this.data=t.data,this.delta=t.delta||c.getTickDuration(t.duration),this.status=128}return e.prototype.buildData=function(t,n,r){return r===void 0&&(r={}),this.tick===null&&(this.tick=c.getRoundedIfClose(this.delta+t.tickPointer)),this.deltaWithPrecisionCorrection=c.getRoundedIfClose(this.delta-n),this.data=c.numberToVariableLength(this.deltaWithPrecisionCorrection).concat(this.status|this.channel-1,c.getPitch(this.pitch,r.middleC),c.convertVelocity(this.velocity)),this},e}(),_=function(){function e(t){this.data=[],this.name="NoteEvent",this.pitch=c.toArray(t.pitch),this.channel=t.channel||1,this.duration=t.duration||"4",this.grace=t.grace,this.repeat=t.repeat||1,this.sequential=t.sequential||!1,this.tick=t.startTick||t.tick||null,this.velocity=t.velocity||50,this.wait=t.wait||0,this.tickDuration=c.getTickDuration(this.duration),this.restDuration=c.getTickDuration(this.wait),this.events=[]}return e.prototype.buildData=function(){var t=this;if(this.data=[],this.grace){var n=1;this.grace=c.toArray(this.grace),this.grace.forEach(function(){var s=new e({pitch:t.grace,duration:"T"+n});t.data=t.data.concat(s.data)})}if(this.sequential)for(var r=0;r<this.repeat;r++)this.pitch.forEach(function(l,u){var g=new B({channel:t.channel,wait:u>0?0:t.wait,delta:u>0?0:c.getTickDuration(t.wait),velocity:t.velocity,pitch:l,tick:t.tick}),N=new V({channel:t.channel,duration:t.duration,velocity:t.velocity,pitch:l});t.events.push(g,N)});else for(var r=0;r<this.repeat;r++)this.pitch.forEach(function(s,l){var u;l==0?u=new B({channel:t.channel,wait:t.wait,delta:c.getTickDuration(t.wait),velocity:t.velocity,pitch:s,tick:t.tick}):u=new B({channel:t.channel,wait:0,delta:0,velocity:t.velocity,pitch:s,tick:t.tick}),t.events.push(u)}),this.pitch.forEach(function(s,l){var u;l==0?u=new V({channel:t.channel,duration:t.duration,velocity:t.velocity,pitch:s,tick:t.tick!==null?c.getTickDuration(t.duration)+t.tick:null}):u=new V({channel:t.channel,duration:0,velocity:t.velocity,pitch:s,tick:t.tick!==null?c.getTickDuration(t.duration)+t.tick:null}),t.events.push(u)});return this},e}(),tt=function(){function e(t){this.channel=t.channel||0,this.delta=t.delta||0,this.name="PitchBendEvent",this.status=224;var n=this.scale14bits(t.bend),r=n&127,s=n>>7&127;this.data=c.numberToVariableLength(this.delta).concat(this.status|this.channel,r,s)}return e.prototype.scale14bits=function(t){return t<=0?Math.floor(16384*(t+1)/2):Math.floor(16383*(t+1)/2)},e}(),ct=function(){function e(t){this.channel=t.channel||0,this.delta=t.delta||0,this.instrument=t.instrument,this.status=192,this.name="ProgramChangeEvent",this.data=c.numberToVariableLength(this.delta).concat(this.status|this.channel,this.instrument)}return e}(),H=function(){function e(t){this.bpm=t.bpm,this.delta=t.delta||0,this.tick=t.tick,this.name="TempoEvent",this.type=81;var n=Math.round(6e7/this.bpm);this.data=c.numberToVariableLength(this.delta).concat(i.META_EVENT_ID,this.type,[3],c.numberToBytes(n,3))}return e}(),et=function(){function e(t){this.delta=t.delta||0,this.text=t.text,this.name="TextEvent",this.type=1;var n=c.stringToBytes(this.text);this.data=c.numberToVariableLength(t.delta).concat(i.META_EVENT_ID,this.type,c.numberToVariableLength(n.length),n)}return e}(),nt=function(){function e(t,n,r,s){this.name="TimeSignatureEvent",this.type=88,this.data=c.numberToVariableLength(0).concat(i.META_EVENT_ID,this.type,[4],c.numberToBytes(t,1),c.numberToBytes(Math.log2(n),1),c.numberToBytes(r||24,1),c.numberToBytes(s||8,1))}return e}(),it=function(){function e(t){this.delta=t.delta||0,this.name="TrackNameEvent",this.text=t.text,this.type=3;var n=c.stringToBytes(this.text);this.data=c.numberToVariableLength(this.delta).concat(i.META_EVENT_ID,this.type,c.numberToVariableLength(n.length),n)}return e}(),rt=function(){function e(){this.type=i.TRACK_CHUNK_TYPE,this.data=[],this.size=[],this.events=[],this.explicitTickEvents=[],this.tickPointer=0}return e.prototype.addEvent=function(t,n){var r=this;return c.toArray(t).forEach(function(s,l){if(s instanceof _){if(typeof n=="function"){var u=n(l,s);typeof u=="object"&&Object.assign(s,u)}s.tick!==null?r.explicitTickEvents.push(s):s.buildData().events.forEach(function(g){return r.events.push(g)})}else r.events.push(s)}),this},e.prototype.buildData=function(t){var n=this;t===void 0&&(t={}),this.data=[],this.size=[],this.tickPointer=0;var r=0;return this.events.forEach(function(s){if(s instanceof B||s instanceof V){var l=s.buildData(n,r,t);r=c.getPrecisionLoss(s.deltaWithPrecisionCorrection||0),n.data=n.data.concat(l.data),n.tickPointer=c.getRoundedIfClose(s.tick)}else s instanceof H&&(n.tickPointer=c.getRoundedIfClose(s.tick)),n.data=n.data.concat(s.data)}),this.mergeExplicitTickEvents(),(!this.events.length||!(this.events[this.events.length-1]instanceof q))&&(this.data=this.data.concat(new q().data)),this.size=c.numberToBytes(this.data.length,4),this},e.prototype.mergeExplicitTickEvents=function(){var t=this;this.explicitTickEvents.length&&(this.explicitTickEvents.sort(function(n,r){return n.tick-r.tick}),this.explicitTickEvents.forEach(function(n){n.buildData().events.forEach(function(r){return r.buildData(t)}),n.events.forEach(function(r){return t.mergeSingleEvent(r)})}),this.explicitTickEvents=[],this.buildData())},e.prototype.mergeTrack=function(t){var n=this;return this.buildData(),t.buildData().events.forEach(function(r){return n.mergeSingleEvent(r)}),this},e.prototype.mergeSingleEvent=function(t){if(!this.events.length){this.addEvent(t);return}for(var n,r=0;r<this.events.length&&!(this.events[r].tick>t.tick);r++)n=r;var s=n+1;t.delta=t.tick-this.events[n].tick,this.events.splice(s,0,t);for(var r=s+1;r<this.events.length;r++)this.events[r].delta=this.events[r].tick-this.events[r-1].tick},e.prototype.removeEventsByName=function(t){var n=this;return this.events.forEach(function(r,s){r.name===t&&n.events.splice(s,1)}),this},e.prototype.setTempo=function(t,n){return n===void 0&&(n=0),this.addEvent(new H({bpm:t,tick:n}))},e.prototype.setTimeSignature=function(t,n,r,s){return this.addEvent(new nt(t,n,r,s))},e.prototype.setKeySignature=function(t,n){return this.addEvent(new X(t,n))},e.prototype.addText=function(t){return this.addEvent(new et({text:t}))},e.prototype.addCopyright=function(t){return this.addEvent(new z({text:t}))},e.prototype.addTrackName=function(t){return this.addEvent(new it({text:t}))},e.prototype.addInstrumentName=function(t){return this.addEvent(new Y({text:t}))},e.prototype.addMarker=function(t){return this.addEvent(new Q({text:t}))},e.prototype.addCuePoint=function(t){return this.addEvent(new J({text:t}))},e.prototype.addLyric=function(t){return this.addEvent(new Z({text:t}))},e.prototype.polyModeOn=function(){var t=new B({data:[0,176,126,0]});return this.addEvent(t)},e.prototype.setPitchBend=function(t){return this.addEvent(new tt({bend:t}))},e.prototype.controllerChange=function(t,n,r,s){return this.addEvent(new A({controllerNumber:t,controllerValue:n,channel:r,delta:s}))},e}(),ut=function(){function e(){}return e.prototype.trackFromVoice=function(t,n){var r=this;n===void 0&&(n={addRenderedAccidentals:!1});var s=new rt,l=[];return t.tickables.forEach(function(u){u.noteType==="n"?(s.addEvent(new _({pitch:u.keys.map(function(g,N){return r.convertPitch(g,N,u,n.addRenderedAccidentals)}),duration:r.convertDuration(u),wait:l})),l=[]):u.noteType==="r"&&l.push(r.convertDuration(u))}),l.length>0&&s.addEvent(new _({pitch:"[c4]",duration:"0",wait:l,velocity:"0"})),s},e.prototype.convertPitch=function(t,n,r,s){var l;s===void 0&&(s=!1);var u=t.split("/"),g=u[0].substring(1).replace("n","");return s&&((l=r.getAccidentals())===null||l===void 0||l.forEach(function(N){N.index===n&&(N.type==="n"?g="":g+=N.type)})),u[0][0]+g+u[1]},e.prototype.convertDuration=function(t){return"d".repeat(t.dots)+this.convertBaseDuration(t.duration)+(t.tuplet?"t"+t.tuplet.num_notes:"")},e.prototype.convertBaseDuration=function(t){switch(t){case"w":return"1";case"h":return"2";case"q":return"4";default:return t}},e}(),lt=function(){function e(t){this.type=i.HEADER_CHUNK_TYPE;var n=t>1?i.HEADER_CHUNK_FORMAT1:i.HEADER_CHUNK_FORMAT0;this.data=n.concat(c.numberToBytes(t,2),i.HEADER_CHUNK_DIVISION),this.size=[0,0,0,this.data.length]}return e}(),ht=function(){function e(t,n){n===void 0&&(n={}),this.tracks=c.toArray(t),this.options=n}return e.prototype.buildData=function(){var t=this,n=[];return n.push(new lt(this.tracks.length)),this.tracks.forEach(function(r){n.push(r.buildData(t.options))}),n},e.prototype.buildFile=function(){var t=[];return this.buildData().forEach(function(n){return t=t.concat(n.type,n.size,n.data)}),new Uint8Array(t)},e.prototype.base64=function(){if(typeof btoa=="function"){for(var t="",n=this.buildFile(),r=n.byteLength,s=0;s<r;s++)t+=String.fromCharCode(n[s]);return btoa(t)}return Buffer.from(this.buildFile()).toString("base64")},e.prototype.dataUri=function(){return"data:audio/midi;base64,"+this.base64()},e.prototype.setOption=function(t,n){return this.options[t]=n,this},e.prototype.stdout=function(){return process.stdout.write(Buffer.from(this.buildFile()))},e}(),dt={Constants:i,ControllerChangeEvent:A,CopyrightEvent:z,CuePointEvent:J,EndTrackEvent:q,InstrumentNameEvent:Y,KeySignatureEvent:X,LyricEvent:Z,MarkerEvent:Q,NoteOnEvent:B,NoteOffEvent:V,NoteEvent:_,PitchBendEvent:tt,ProgramChangeEvent:ct,TempoEvent:H,TextEvent:et,TimeSignatureEvent:nt,Track:rt,TrackNameEvent:it,Utils:c,VexFlow:ut,Writer:ht};return $=dt,$}var Tt=xt();const K=mt(Tt);function kt(i){const a={textarea:i.querySelector("#note-input-textarea"),renderButton:i.querySelector("#render-notes-button"),displayArea:i.querySelector("#note-sequence-display-area"),clefSelect:i.querySelector("#clef-select"),keySignatureSelect:i.querySelector("#key-signature-select"),timeSignatureSelect:i.querySelector("#time-signature-select"),examplesList:i.querySelector("#note-examples-list"),vexFlowTargetId:"note-seq-vexflow-output",playButton:i.querySelector(".play-button"),stopButton:i.querySelector(".stop-button"),bpmInput:i.querySelector("#bpm-input"),exportMidiButton:i.querySelector("#export-midi-button")};return!a.textarea||!a.renderButton||!a.displayArea||!a.clefSelect||!a.keySignatureSelect||!a.timeSignatureSelect||!a.examplesList?(console.error("NoteSequenceRenderer Error: 找不到所需的 UI 元素 (包括调号选择框)。"),null):(a.vexFlowContainer=()=>i.querySelector(`#${a.vexFlowTargetId}`),a)}function W(i){if(!i)return[];const a={w:"w",1:"w",h:"h",2:"h",q:"q",4:"q",8:"8",16:"16",32:"32",64:"64"},o="q",d=/([A-Ga-g])(##|x|#|bb|b)?(\d)/i,p=/([A-Ga-g])(##|x|#|bb|b)?(\d)/gi,h=(f,b,y)=>{let m="";if(b){const x=b.toLowerCase();x==="##"||x==="x"?m="##":x==="bb"?m="bb":x==="#"?m="#":x==="b"&&(m="b")}return/^\d+$/.test(y)?`${f.toLowerCase()}${m}/${y}`:(console.warn(`无效的八度音 "${y}" 在 ${f}${b||""}${y} 中`),null)},E=i.trim().split(/\s+/).filter(f=>f.length>0),T=[];let v=!1;return E.forEach(f=>{if(v)return;let b=f,y=o,m=0;if(f.includes("/")){const k=f.lastIndexOf("/");b=f.substring(0,k);let C=f.substring(k+1).toLowerCase();C.endsWith("d")&&(m=1,C=C.slice(0,-1));const w=a[C];if(w)y=w;else{console.warn(`无法识别的时值 "${f.substring(k+1)}" in "${f}"`),v=!0;return}}const x=b.trim().toLowerCase();if(x==="r"||x==="z")T.push({keys:["b/4"],duration:y+"r",dots:m,isRest:!0});else{let k=[];const C=b.match(d);if(C&&C[0]===b){const[,w,D,S]=C,I=h(w,D,S);I?k.push(I):v=!0}else{let w,D=0,S=!1;for(p.lastIndex=0;(w=p.exec(b))!==null;){if(w.index!==D){v=!0,k=[];break}S=!0;const[,I,L,c]=w,A=h(I,L,c);if(A)k.push(A);else{v=!0,k=[];break}D=p.lastIndex}!v&&D!==b.length&&(v=!0,k=[]),!S&&!v&&(v=!0)}!v&&k.length>0&&T.push({keys:k,duration:y,dots:m,isRest:!1})}}),v?null:T}function wt(i){if(!i||typeof i.duration!="string")return console.error("Invalid noteInfo passed to getNoteDurationValue:",i),0;const a=i.duration.replace("r","");let o=0;switch(a){case"w":case"1":o=4;break;case"h":case"2":o=2;break;case"q":case"4":o=1;break;case"8":o=.5;break;case"16":o=.25;break;case"32":o=.125;break;case"64":o=.0625;break;default:return console.warn(`Unknown duration string for value calculation: "${a}" in note:`,i),0}return i.dots&&i.dots>0&&(o*=1.5),o}function Ct(i){const a=i.toUpperCase();if(a==="FREE")return 1/0;if(a==="C"||a==="C|"||a==="2/2")return 4;if(i.includes("/"))try{const[o,d]=i.split("/"),p=parseInt(o,10),h=parseInt(d,10);if(!isNaN(p)&&!isNaN(h)&&h>0)return p*(4/h)}catch(o){console.error("Error parsing time signature for duration:",o)}return console.warn(`Could not parse time signature "${i}", defaulting to 4/4 measure duration.`),4}function Nt(i,a){if(a.toUpperCase()==="FREE")return console.log("Free Time selected, skipping barline insertion."),i;if(!i||i.length===0)return[];const o=Ct(a);if(!isFinite(o)||o<=0)return console.warn("Invalid or non-positive measure duration, skipping barline insertion."),i;const d=[];let p=0;const h=1e-4;return i.forEach((E,T)=>{d.push(E);const v=wt(E);p+=v,p>=o-h&&(T<i.length-1&&d.push({type:"barline",barType:"single"}),p-=o,Math.abs(p)<h&&(p=0))}),d}function G(i,a,o,d,p){let T=60;o&&o!=="C"&&(T+=30+(o.length-1)*8),d&&d.toUpperCase()!=="FREE"&&(T+=30);let v=0;i.forEach(b=>{b.type==="barline"?v+=10:v+=45});let f=T+v+20;return f=Math.max(300,f),{elementId:p,width:f,height:150,staves:[{clef:a,keySignature:o,timeSignature:d.toUpperCase()==="FREE"?void 0:d,notes:i}]}}function F(i,a){i?i.innerHTML=`<p style="color: red;">${a}</p>`:console.error("错误显示失败: 容器无效。",a)}function Dt(i){const{textarea:a,clefSelect:o,keySignatureSelect:d,timeSignatureSelect:p,displayArea:h,vexFlowTargetId:E,vexFlowContainer:T}=i;h.innerHTML=`<div id="${E}"></div>`;const v=T();if(!v){F(h,"错误：无法创建 VexFlow 渲染目标。");return}const f=a.value,b=o.value,y=d.value,m=p.value;try{const x=W(f);if(x===null){F(v,"输入解析错误：包含无法识别的格式。");const w=G([],b,y,m,E);j(w.elementId,w);return}const k=Nt(x,m),C=G(k,b,y,m,E);j(C.elementId,C),console.log("乐谱渲染请求已处理 (含调号)。")}catch(x){console.error("处理渲染请求时发生意外错误:",x),F(v,`渲染时发生内部错误: ${x.message}`)}}function ot(i){const a=i.duration.replace("r","");let o=0;switch(a){case"w":case"1":o=4;break;case"h":case"2":o=2;break;case"q":case"4":o=1;break;case"8":o=.5;break;case"16":o=.25;break;case"32":o=.125;break;case"64":o=.0625;break;default:return console.warn(`Unknown duration for beat calculation: ${a}`),0}return i.dots&&i.dots>0&&(o*=1.5),o}function st(i){if(!i||typeof i!="string")return null;const a=i.match(/([a-g])(##|x|#|bb|b)?\/?(\d)/i);if(!a)return i;const o=a[1].toUpperCase();let d=a[2]||"";d==="x"&&(d="##");const p=a[3];return`${o}${d}${p}`}function Mt(i){let a=0;const o=[];return i?(i.forEach(d=>{const p=ot(d);if(!d.isRest&&d.keys&&d.keys.length>0){const h=d.keys.map(st).filter(E=>E!==null);h.length>0&&o.push({type:"note",pitch:h.length===1?h[0]:h,startTime:a,duration:p})}a+=p}),o):[]}function St(i,a){const o=ot(i);return Math.round(o*a)}function It(i){try{const a=st(i);return a?bt(a).toMidi():null}catch(a){return console.warn(`[MIDI Helper] Could not convert key "${i}" to MIDI number:`,a),null}}function Bt(i,a,o,d){if(!i||i.length===0)return console.warn("[MIDI Export] No notes to export."),null;const p=128;try{const h=new K.Track;if(h.setTempo(a),o&&o.toUpperCase()!=="FREE"&&o.includes("/"))try{const[v,f]=o.split("/").map(Number);!isNaN(v)&&!isNaN(f)&&h.setTimeSignature(v,f)}catch(v){console.warn("[MIDI Export] Failed to set time signature:",v)}let E=0;return i.forEach(v=>{const f=St(v,p);if(!v.isRest&&v.keys&&v.keys.length>0){const b=v.keys.map(It).filter(y=>y!==null);if(b.length>0){const y=new K.NoteEvent({pitch:b,duration:`T${f}`,startTick:E,velocity:100,sequential:!1});h.addEvent(y)}}E+=f}),new K.Writer([h]).dataUri()}catch(h){return console.error("[MIDI Export] Error generating MIDI data:",h),null}}function At(i,a){if(!i)return;const o=document.createElement("a");o.href=i,o.download=a,document.body.appendChild(o),o.click(),document.body.removeChild(o)}function Vt(i){i.renderButton?i.renderButton.addEventListener("click",()=>Dt(i)):console.error("无法绑定事件：渲染按钮未找到。"),i.playButton&&i.textarea&&i.bpmInput?i.playButton.addEventListener("click",async()=>{console.log("Play button clicked");try{await vt();const a=parseInt(i.bpmInput.value,10);if(isNaN(a)||a<30||a>500){alert("Please enter a valid BPM (30-500)."),console.error("Invalid BPM:",i.bpmInput.value);return}const o=a,d=i.textarea.value,p=W(d);if(p===null){alert("Input contains invalid notes. Cannot play."),console.error("Parsing failed for audio playback.");return}if(p.length===0){console.log("No notes to play.");return}const h=Mt(p);if(console.log("Audio Events:",h),h.length===0&&p.length>0){console.log("Parsed notes resulted in no playable audio events (maybe only rests?).");return}if(h.length===0){console.log("No audio events generated.");return}ft(h,o),i.playButton.disabled=!0,i.stopButton.disabled=!1}catch(a){console.error("Error during play sequence setup:",a),alert(`Failed to start playback: ${a.message}`),i.playButton&&(i.playButton.disabled=!1),i.stopButton&&(i.stopButton.disabled=!0)}}):console.warn("无法绑定播放事件：播放按钮、文本框或 BPM 输入框未找到。"),i.stopButton?(i.stopButton.disabled=!0,i.stopButton.addEventListener("click",()=>{console.log("Stop button clicked"),Et(),i.playButton&&(i.playButton.disabled=!1),i.stopButton.disabled=!0})):console.warn("无法绑定停止事件：停止按钮未找到。"),gt.on("stop",()=>{console.log("Tone Transport stopped event detected."),i.playButton&&(i.playButton.disabled=!1),i.stopButton&&(i.stopButton.disabled=!0)}),i.exportMidiButton&&i.textarea&&i.bpmInput&&i.timeSignatureSelect&&i.keySignatureSelect?i.exportMidiButton.addEventListener("click",()=>{console.log("Export MIDI button clicked");try{const a=i.textarea.value,o=parseInt(i.bpmInput.value,10),d=i.timeSignatureSelect.value,p=i.keySignatureSelect.value;if(isNaN(o)||o<30||o>500){alert("Please enter a valid BPM (30-500) for MIDI export.");return}const h=W(a);if(h===null){alert("Input contains invalid notes. Cannot export MIDI.");return}if(h.length===0){alert("No notes to export to MIDI.");return}const E=Bt(h,o,d,p);E?(At(E,"music-sequence.mid"),console.log("MIDI file export initiated.")):alert("Failed to generate MIDI file.")}catch(a){console.error("Error during MIDI export:",a),alert(`Failed to export MIDI: ${a.message}`)}}):console.warn("无法绑定 MIDI 导出事件：缺少按钮或相关控件。")}function _t(i){if(!i){console.error("NoteSequenceRenderer 初始化失败: 未提供容器元素。");return}i.innerHTML=yt;const a=kt(i);if(a){Vt(a),a.examplesList&&a.textarea&&a.examplesList.addEventListener("click",o=>{if(o.target.classList.contains("example-input")){const d=o.target.textContent;a.textarea.value=d,a.textarea.focus(),console.log(`填充示例: ${d}`)}});try{a.displayArea.innerHTML=`<div id="${a.vexFlowTargetId}"><p>请在上方输入音符并点击 'Render Score'。</p></div>`;const o=a.vexFlowContainer();if(o){const d=a.keySignatureSelect.value,p=a.timeSignatureSelect.value,h=G([],a.clefSelect.value,d,p,a.vexFlowTargetId);o.innerHTML="",j(h.elementId,h)}else F(a.displayArea,"无法创建初始 VexFlow 渲染目标。")}catch(o){console.error("初始渲染失败:",o),F(a.displayArea,`初始渲染失败: ${o.message}`)}console.log("音符序列渲染器工具已初始化 (支持调号)。")}}export{_t as initializeNoteSequenceRenderer};
