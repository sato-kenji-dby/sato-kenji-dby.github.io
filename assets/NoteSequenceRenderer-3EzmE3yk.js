import{i as l}from"./index-BVysS7N4.js";import{i as fe,p as ge,T as ye,M as be,s as Ee}from"./audio-player-C8eAfouR.js";import{c as W}from"./vexflow-helper-BJ71SLUW.js";const me=`<!-- src/tools/NoteSequenceRenderer/NoteSequenceRenderer.html -->

<div class="tool-section note-sequence-renderer-tool">
    <h3 data-i18n="note-Sequence-Renderer.title">音符序列渲染器</h3>
    <p data-i18n="note-Sequence-Renderer.description">
        输入音符序列。用空格分隔表示旋律，直接连接表示和弦。使用 <code>/</code> 指定时值 (h, q, 8, 16, 32, 64) 和附点 (<code>d</code>)，用 <code>r</code> 或 <code>z</code> 表示休止符。
    </p>
    <div class="examples-section">
        <p data-i18n="note-Sequence-Renderer.examples.title">点击下面的示例可以填充到输入框：</p>
        <ul id="note-examples-list" class="examples-list">
            <li><span class="example-input" data-i18n="[title]note-Sequence-Renderer.examples.clickToFill">C4/h D4/q r/8 E#4/16d Z/q C4E4G4/w</span> <small data-i18n="note-Sequence-Renderer.examples.mixed">(混合)</small></li>
            <li><span class="example-input" data-i18n="[title]note-Sequence-Renderer.examples.clickToFill">G3B3D4/h r/h C5/q C5/q</span> <small data-i18n="note-Sequence-Renderer.examples.chordsAndRests">(和弦与休止)</small></li>
            <li><span class="example-input" data-i18n="[title]note-Sequence-Renderer.examples.clickToFill">A4/8 B4/8 C5/8 D5/8 E5/q F5/q</span> <small data-i18n="note-Sequence-Renderer.examples.melody">(旋律)</small></li>
        </ul>
    </div>

    <!-- 工具栏选项 -->
    <div class="score-options">
        <div class="option-group">
            <label for="clef-select" data-i18n="note-Sequence-Renderer.options.clef">Clef:</label>
            <select id="clef-select">
                <option value="treble" selected data-i18n="note-Sequence-Renderer.options.clefs.treble">Treble</option>
                <option value="bass" data-i18n="note-Sequence-Renderer.options.clefs.bass">Bass</option>
                <option value="alto" data-i18n="note-Sequence-Renderer.options.clefs.alto">Alto</option>
                <option value="tenor" data-i18n="note-Sequence-Renderer.options.clefs.tenor">Tenor</option>
            </select>
        </div>
        <!-- **** 新增：调号选择 **** -->
        <div class="option-group">
            <label for="key-signature-select" data-i18n="note-Sequence-Renderer.options.keySignature">Key Sig.:</label>
            <select id="key-signature-select">
                <option value="C" selected data-i18n="note-Sequence-Renderer.options.keys.c">C Maj / A min</option>
                <option value="G" data-i18n="note-Sequence-Renderer.options.keys.g">G Maj / E min (1♯)</option>
                <option value="D" data-i18n="note-Sequence-Renderer.options.keys.d">D Maj / B min (2♯)</option>
                <option value="A" data-i18n="note-Sequence-Renderer.options.keys.a">A Maj / F♯ min (3♯)</option>
                <option value="E" data-i18n="note-Sequence-Renderer.options.keys.e">E Maj / C♯ min (4♯)</option>
                <option value="B" data-i18n="note-Sequence-Renderer.options.keys.b">B Maj / G♯ min (5♯)</option>
                <option value="F#" data-i18n="note-Sequence-Renderer.options.keys.fSharp">F♯ Maj / D♯ min (6♯)</option>
                <option value="C#" data-i18n="note-Sequence-Renderer.options.keys.cSharp">C♯ Maj / A♯ min (7♯)</option>
                <option value="F" data-i18n="note-Sequence-Renderer.options.keys.f">F Maj / D min (1♭)</option>
                <option value="Bb" data-i18n="note-Sequence-Renderer.options.keys.bb">B♭ Maj / G min (2♭)</option>
                <option value="Eb" data-i18n="note-Sequence-Renderer.options.keys.eb">E♭ Maj / C min (3♭)</option>
                <option value="Ab" data-i18n="note-Sequence-Renderer.options.keys.ab">A♭ Maj / F min (4♭)</option>
                <option value="Db" data-i18n="note-Sequence-Renderer.options.keys.db">D♭ Maj / B♭ min (5♭)</option>
                <option value="Gb" data-i18n="note-Sequence-Renderer.options.keys.gb">G♭ Maj / E♭ min (6♭)</option>
                <option value="Cb" data-i18n="note-Sequence-Renderer.options.keys.cb">C♭ Maj / A♭ min (7♭)</option>
                <!-- 可以添加更多不常用的调号或区分大小调 -->
            </select>
        </div>
        <!-- **** 结束新增 **** -->
        <div class="option-group">
            <label for="time-signature-select" data-i18n="note-Sequence-Renderer.options.timeSignature">Time Sig.:</label>
            <select id="time-signature-select">
                <option value="4/4" selected>4/4</option>
                <option value="C" data-i18n="note-Sequence-Renderer.options.times.common">C (Common Time)</option>
                <option value="3/4">3/4</option>
                <option value="2/4">2/4</option>
                <option value="6/8">6/8</option>
                <option value="C|" data-i18n="note-Sequence-Renderer.options.times.cut">Cut Time (2/2)</option>
                <option value="free" data-i18n="note-Sequence-Renderer.options.times.free">Free Time</option>
            </select>
        </div>
    </div>

    <!-- 输入区域 -->
    <div class="note-input-area">
        <label for="note-input-textarea" data-i18n="note-Sequence-Renderer.inputLabel">输入音符:</label>
        <textarea id="note-input-textarea" rows="3" data-i18n="[placeholder]note-Sequence-Renderer.inputPlaceholder"></textarea>
    </div>

    <!-- 按钮 -->
    <button id="render-notes-button" data-i18n="note-Sequence-Renderer.renderButton">Render Score</button>

    <div></div>
    <!-- VexFlow 显示区域 -->
    <div id="note-sequence-display-area" class="vexflow-score-container" style="min-height: 150px;">
        <p data-i18n="note-Sequence-Renderer.initialMessage">在此处将显示渲染的乐谱。</p>
    </div>
    
    <div class="playback-export-controls input-section">
        <h4 data-i18n="note-Sequence-Renderer.playbackExport.title">播放与导出</h4>
        <div class="option-group">
            <!-- Keep original class for JS, add new style class -->
            <button class="play-button button-primary" data-i18n="note-Sequence-Renderer.playbackExport.play">播放</button> 
            <button class="stop-button button-secondary" data-i18n="note-Sequence-Renderer.playbackExport.stop">停止</button> 
        </div>
        <div class="option-group">
            <!-- Keep original ID for JS -->
            <label for="bpm-input">BPM:</label>
            <input type="number" id="bpm-input" value="120" min="30" max="300" style="width: 80px;">
        </div>
        <div class="option-group">
            <!-- Keep original ID for JS, update class for styling -->
            <button id="export-midi-button" class="button-secondary" data-i18n="note-Sequence-Renderer.playbackExport.exportMidi">导出 MIDI</button> 
        </div>
    </div>
</div>
`;function xe(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var j,ae;function Se(){if(ae)return j;ae=1;var r={VERSION:"3.1.1",HEADER_CHUNK_TYPE:[77,84,104,100],HEADER_CHUNK_LENGTH:[0,0,0,6],HEADER_CHUNK_FORMAT0:[0,0],HEADER_CHUNK_FORMAT1:[0,1],HEADER_CHUNK_DIVISION:[0,128],TRACK_CHUNK_TYPE:[77,84,114,107],META_EVENT_ID:255,META_SMTPE_OFFSET:84},o=(t,e)=>Array(Math.abs(e)+1).join(t);function a(t){return t!==null&&typeof t=="object"&&typeof t.name=="string"}function p(t){return t!==null&&typeof t=="object"&&typeof t.step=="number"&&typeof t.alt=="number"}var v=[0,2,4,-1,1,3,5],h=v.map(t=>Math.floor(t*7/12));function E(t){const{step:e,alt:n,oct:i,dir:s=1}=t,d=v[e]+7*n;if(i===void 0)return[s*d];const u=i-h[e]-4*n;return[s*d,s*u]}var T={empty:!0,name:"",pc:"",acc:""},f=new Map,g=t=>"CDEFGAB".charAt(t),b=t=>t<0?o("b",-t):o("#",t),m=t=>t[0]==="b"?-t.length:t.length;function x(t){const e=JSON.stringify(t),n=f.get(e);if(n)return n;const i=typeof t=="string"?C(t):p(t)?x(B(t)):a(t)?x(t.name):T;return f.set(e,i),i}var S=/^([a-gA-G]?)(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)$/;function k(t){const e=S.exec(t);return[e[1].toUpperCase(),e[2].replace(/x/g,"##"),e[3],e[4]]}var q=(t,e)=>(t%e+e)%e,R=[0,2,4,5,7,9,11];function C(t){const e=k(t);if(e[0]===""||e[3]!=="")return T;const n=e[0],i=e[1],s=e[2],d=(n.charCodeAt(0)+3)%7,u=m(i),y=s.length?+s:void 0,w=E({step:d,alt:u,oct:y}),_=n+i+s,U=n+i,P=(R[d]+u+120)%12,N=y===void 0?q(R[d]+u,12)-12*99:R[d]+u+12*(y+1),K=N>=0&&N<=127?N:null,ve=y===void 0?null:Math.pow(2,(N-69)/12)*440;return{empty:!1,acc:i,alt:u,chroma:P,coord:w,freq:ve,height:N,letter:n,midi:K,name:_,oct:y,pc:U,step:d}}function B(t){const{step:e,alt:n,oct:i}=t,s=g(e);if(!s)return"";const d=s+b(n);return i||i===0?d+i:d}function D(t){return+t>=0&&+t<=127}function L(t){if(D(t))return+t;const e=x(t);return e.empty?null:e.midi}var c=function(){function t(){}return t.version=function(){return r.VERSION},t.stringToBytes=function(e){return e.split("").map(function(n){return n.charCodeAt(0)})},t.isNumeric=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},t.getPitch=function(e,n){return n===void 0&&(n="C4"),60-L(n)+L(e)},t.numberToVariableLength=function(e){e=Math.round(e);for(var n=e&127;e=e>>7;)n<<=8,n|=e&127|128;for(var i=[];i.push(n&255),n&128;)n>>=8;return i},t.stringByteCount=function(e){return encodeURI(e).split(/%..|./).length-1},t.numberFromBytes=function(e){var n="",i;return e.forEach(function(s){i=s.toString(16),i.length==1&&(i="0"+i),n+=i}),parseInt(n,16)},t.numberToBytes=function(e,n){n=n||1;var i=e.toString(16);i.length&1&&(i="0"+i);var s=i.match(/.{2}/g),d=s.map(function(u){return parseInt(u,16)});if(d.length<n)for(;n-d.length>0;)d.unshift(0);return d},t.toArray=function(e){return Array.isArray(e)?e:[e]},t.convertVelocity=function(e){return e=e>100?100:e,Math.round(e/100*127)},t.getTickDuration=function(e){if(Array.isArray(e))return e.map(function(d){return t.getTickDuration(d)}).reduce(function(d,u){return d+u},0);if(e=e.toString(),e.toLowerCase().charAt(0)==="t"){var n=parseInt(e.substring(1));if(isNaN(n)||n<0)throw new Error(e+" is not a valid duration.");return n}var i=t.numberFromBytes(r.HEADER_CHUNK_DIVISION),s=i*t.getDurationMultiplier(e);return t.getRoundedIfClose(s)},t.getRoundedIfClose=function(e){var n=Math.round(e);return Math.abs(n-e)<1e-6?n:e},t.getPrecisionLoss=function(e){var n=Math.round(e);return n-e},t.getDurationMultiplier=function(e){if(e==="0")return 0;var n=e.match(/^(?<dotted>d+)?(?<base>\d+)(?:t(?<tuplet>\d*))?/);if(n){var i=Number(n.groups.base),s=i===1||(i&i-1)===0;if(s){var d=i/4,u=1/d,y=n.groups,w=y.dotted,_=y.tuplet;if(w){var U=w.length,P=Math.pow(2,U);u=u+u*((P-1)/P)}if(typeof _=="string"){var N=u*2,K=Number(_||"3");u=N/K}return u}}throw new Error(e+" is not a valid duration.")},t}(),A=function(){function t(e){this.channel=e.channel-1||0,this.controllerValue=e.controllerValue,this.controllerNumber=e.controllerNumber,this.delta=e.delta||0,this.name="ControllerChangeEvent",this.status=176,this.data=c.numberToVariableLength(e.delta).concat(this.status|this.channel,this.controllerNumber,this.controllerValue)}return t}(),J=function(){function t(e){this.delta=e.delta||0,this.name="CopyrightEvent",this.text=e.text,this.type=2;var n=c.stringToBytes(this.text);this.data=c.numberToVariableLength(this.delta).concat(r.META_EVENT_ID,this.type,c.numberToVariableLength(n.length),n)}return t}(),Y=function(){function t(e){this.delta=e.delta||0,this.name="CuePointEvent",this.text=e.text,this.type=7;var n=c.stringToBytes(this.text);this.data=c.numberToVariableLength(this.delta).concat(r.META_EVENT_ID,this.type,c.numberToVariableLength(n.length),n)}return t}(),H=function(){function t(e){this.delta=(e==null?void 0:e.delta)||0,this.name="EndTrackEvent",this.type=[47,0],this.data=c.numberToVariableLength(this.delta).concat(r.META_EVENT_ID,this.type)}return t}(),X=function(){function t(e){this.delta=e.delta||0,this.name="InstrumentNameEvent",this.text=e.text,this.type=4;var n=c.stringToBytes(this.text);this.data=c.numberToVariableLength(this.delta).concat(r.META_EVENT_ID,this.type,c.numberToVariableLength(n.length),n)}return t}(),Z=function(){function t(e,n){this.name="KeySignatureEvent",this.type=89;var i=n||0;if(e=e||0,typeof n>"u"){var s=[["Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#"],["ab","eb","bb","f","c","g","d","a","e","b","f#","c#","g#","d#","a#"]],d=e.length,u=e||"C";if(e[0]===e[0].toLowerCase()&&(i=1),d>1)switch(e.charAt(d-1)){case"m":i=1,u=e.charAt(0).toLowerCase(),u=u.concat(e.substring(1,d-1));break;case"-":i=1,u=e.charAt(0).toLowerCase(),u=u.concat(e.substring(1,d-1));break;case"M":i=0,u=e.charAt(0).toUpperCase(),u=u.concat(e.substring(1,d-1));break;case"+":i=0,u=e.charAt(0).toUpperCase(),u=u.concat(e.substring(1,d-1));break}var y=s[i].indexOf(u);e=y===-1?0:y-7}this.data=c.numberToVariableLength(0).concat(r.META_EVENT_ID,this.type,[2],c.numberToBytes(e,1),c.numberToBytes(i,1))}return t}(),Q=function(){function t(e){this.delta=e.delta||0,this.name="LyricEvent",this.text=e.text,this.type=5;var n=c.stringToBytes(this.text);this.data=c.numberToVariableLength(this.delta).concat(r.META_EVENT_ID,this.type,c.numberToVariableLength(n.length),n)}return t}(),ee=function(){function t(e){this.delta=e.delta||0,this.name="MarkerEvent",this.text=e.text,this.type=6;var n=c.stringToBytes(this.text);this.data=c.numberToVariableLength(this.delta).concat(r.META_EVENT_ID,this.type,c.numberToVariableLength(n.length),n)}return t}(),M=function(){function t(e){this.name="NoteOnEvent",this.channel=e.channel||1,this.pitch=e.pitch,this.wait=e.wait||0,this.velocity=e.velocity||50,this.tick=e.tick||null,this.delta=null,this.data=e.data,this.status=144}return t.prototype.buildData=function(e,n,i){return i===void 0&&(i={}),this.data=[],this.tick?(this.tick=c.getRoundedIfClose(this.tick),e.tickPointer==0&&(this.delta=this.tick)):(this.delta=c.getTickDuration(this.wait),this.tick=c.getRoundedIfClose(e.tickPointer+this.delta)),this.deltaWithPrecisionCorrection=c.getRoundedIfClose(this.delta-n),this.data=c.numberToVariableLength(this.deltaWithPrecisionCorrection).concat(this.status|this.channel-1,c.getPitch(this.pitch,i.middleC),c.convertVelocity(this.velocity)),this},t}(),F=function(){function t(e){this.name="NoteOffEvent",this.channel=e.channel||1,this.pitch=e.pitch,this.velocity=e.velocity||50,this.tick=e.tick||null,this.data=e.data,this.delta=e.delta||c.getTickDuration(e.duration),this.status=128}return t.prototype.buildData=function(e,n,i){return i===void 0&&(i={}),this.tick===null&&(this.tick=c.getRoundedIfClose(this.delta+e.tickPointer)),this.deltaWithPrecisionCorrection=c.getRoundedIfClose(this.delta-n),this.data=c.numberToVariableLength(this.deltaWithPrecisionCorrection).concat(this.status|this.channel-1,c.getPitch(this.pitch,i.middleC),c.convertVelocity(this.velocity)),this},t}(),I=function(){function t(e){this.data=[],this.name="NoteEvent",this.pitch=c.toArray(e.pitch),this.channel=e.channel||1,this.duration=e.duration||"4",this.grace=e.grace,this.repeat=e.repeat||1,this.sequential=e.sequential||!1,this.tick=e.startTick||e.tick||null,this.velocity=e.velocity||50,this.wait=e.wait||0,this.tickDuration=c.getTickDuration(this.duration),this.restDuration=c.getTickDuration(this.wait),this.events=[]}return t.prototype.buildData=function(){var e=this;if(this.data=[],this.grace){var n=1;this.grace=c.toArray(this.grace),this.grace.forEach(function(){var s=new t({pitch:e.grace,duration:"T"+n});e.data=e.data.concat(s.data)})}if(this.sequential)for(var i=0;i<this.repeat;i++)this.pitch.forEach(function(d,u){var y=new M({channel:e.channel,wait:u>0?0:e.wait,delta:u>0?0:c.getTickDuration(e.wait),velocity:e.velocity,pitch:d,tick:e.tick}),w=new F({channel:e.channel,duration:e.duration,velocity:e.velocity,pitch:d});e.events.push(y,w)});else for(var i=0;i<this.repeat;i++)this.pitch.forEach(function(s,d){var u;d==0?u=new M({channel:e.channel,wait:e.wait,delta:c.getTickDuration(e.wait),velocity:e.velocity,pitch:s,tick:e.tick}):u=new M({channel:e.channel,wait:0,delta:0,velocity:e.velocity,pitch:s,tick:e.tick}),e.events.push(u)}),this.pitch.forEach(function(s,d){var u;d==0?u=new F({channel:e.channel,duration:e.duration,velocity:e.velocity,pitch:s,tick:e.tick!==null?c.getTickDuration(e.duration)+e.tick:null}):u=new F({channel:e.channel,duration:0,velocity:e.velocity,pitch:s,tick:e.tick!==null?c.getTickDuration(e.duration)+e.tick:null}),e.events.push(u)});return this},t}(),te=function(){function t(e){this.channel=e.channel||0,this.delta=e.delta||0,this.name="PitchBendEvent",this.status=224;var n=this.scale14bits(e.bend),i=n&127,s=n>>7&127;this.data=c.numberToVariableLength(this.delta).concat(this.status|this.channel,i,s)}return t.prototype.scale14bits=function(e){return e<=0?Math.floor(16384*(e+1)/2):Math.floor(16383*(e+1)/2)},t}(),ue=function(){function t(e){this.channel=e.channel||0,this.delta=e.delta||0,this.instrument=e.instrument,this.status=192,this.name="ProgramChangeEvent",this.data=c.numberToVariableLength(this.delta).concat(this.status|this.channel,this.instrument)}return t}(),O=function(){function t(e){this.bpm=e.bpm,this.delta=e.delta||0,this.tick=e.tick,this.name="TempoEvent",this.type=81;var n=Math.round(6e7/this.bpm);this.data=c.numberToVariableLength(this.delta).concat(r.META_EVENT_ID,this.type,[3],c.numberToBytes(n,3))}return t}(),ne=function(){function t(e){this.delta=e.delta||0,this.text=e.text,this.name="TextEvent",this.type=1;var n=c.stringToBytes(this.text);this.data=c.numberToVariableLength(e.delta).concat(r.META_EVENT_ID,this.type,c.numberToVariableLength(n.length),n)}return t}(),re=function(){function t(e,n,i,s){this.name="TimeSignatureEvent",this.type=88,this.data=c.numberToVariableLength(0).concat(r.META_EVENT_ID,this.type,[4],c.numberToBytes(e,1),c.numberToBytes(Math.log2(n),1),c.numberToBytes(i||24,1),c.numberToBytes(s||8,1))}return t}(),ie=function(){function t(e){this.delta=e.delta||0,this.name="TrackNameEvent",this.text=e.text,this.type=3;var n=c.stringToBytes(this.text);this.data=c.numberToVariableLength(this.delta).concat(r.META_EVENT_ID,this.type,c.numberToVariableLength(n.length),n)}return t}(),oe=function(){function t(){this.type=r.TRACK_CHUNK_TYPE,this.data=[],this.size=[],this.events=[],this.explicitTickEvents=[],this.tickPointer=0}return t.prototype.addEvent=function(e,n){var i=this;return c.toArray(e).forEach(function(s,d){if(s instanceof I){if(typeof n=="function"){var u=n(d,s);typeof u=="object"&&Object.assign(s,u)}s.tick!==null?i.explicitTickEvents.push(s):s.buildData().events.forEach(function(y){return i.events.push(y)})}else i.events.push(s)}),this},t.prototype.buildData=function(e){var n=this;e===void 0&&(e={}),this.data=[],this.size=[],this.tickPointer=0;var i=0;return this.events.forEach(function(s){if(s instanceof M||s instanceof F){var d=s.buildData(n,i,e);i=c.getPrecisionLoss(s.deltaWithPrecisionCorrection||0),n.data=n.data.concat(d.data),n.tickPointer=c.getRoundedIfClose(s.tick)}else s instanceof O&&(n.tickPointer=c.getRoundedIfClose(s.tick)),n.data=n.data.concat(s.data)}),this.mergeExplicitTickEvents(),(!this.events.length||!(this.events[this.events.length-1]instanceof H))&&(this.data=this.data.concat(new H().data)),this.size=c.numberToBytes(this.data.length,4),this},t.prototype.mergeExplicitTickEvents=function(){var e=this;this.explicitTickEvents.length&&(this.explicitTickEvents.sort(function(n,i){return n.tick-i.tick}),this.explicitTickEvents.forEach(function(n){n.buildData().events.forEach(function(i){return i.buildData(e)}),n.events.forEach(function(i){return e.mergeSingleEvent(i)})}),this.explicitTickEvents=[],this.buildData())},t.prototype.mergeTrack=function(e){var n=this;return this.buildData(),e.buildData().events.forEach(function(i){return n.mergeSingleEvent(i)}),this},t.prototype.mergeSingleEvent=function(e){if(!this.events.length){this.addEvent(e);return}for(var n,i=0;i<this.events.length&&!(this.events[i].tick>e.tick);i++)n=i;var s=n+1;e.delta=e.tick-this.events[n].tick,this.events.splice(s,0,e);for(var i=s+1;i<this.events.length;i++)this.events[i].delta=this.events[i].tick-this.events[i-1].tick},t.prototype.removeEventsByName=function(e){var n=this;return this.events.forEach(function(i,s){i.name===e&&n.events.splice(s,1)}),this},t.prototype.setTempo=function(e,n){return n===void 0&&(n=0),this.addEvent(new O({bpm:e,tick:n}))},t.prototype.setTimeSignature=function(e,n,i,s){return this.addEvent(new re(e,n,i,s))},t.prototype.setKeySignature=function(e,n){return this.addEvent(new Z(e,n))},t.prototype.addText=function(e){return this.addEvent(new ne({text:e}))},t.prototype.addCopyright=function(e){return this.addEvent(new J({text:e}))},t.prototype.addTrackName=function(e){return this.addEvent(new ie({text:e}))},t.prototype.addInstrumentName=function(e){return this.addEvent(new X({text:e}))},t.prototype.addMarker=function(e){return this.addEvent(new ee({text:e}))},t.prototype.addCuePoint=function(e){return this.addEvent(new Y({text:e}))},t.prototype.addLyric=function(e){return this.addEvent(new Q({text:e}))},t.prototype.polyModeOn=function(){var e=new M({data:[0,176,126,0]});return this.addEvent(e)},t.prototype.setPitchBend=function(e){return this.addEvent(new te({bend:e}))},t.prototype.controllerChange=function(e,n,i,s){return this.addEvent(new A({controllerNumber:e,controllerValue:n,channel:i,delta:s}))},t}(),le=function(){function t(){}return t.prototype.trackFromVoice=function(e,n){var i=this;n===void 0&&(n={addRenderedAccidentals:!1});var s=new oe,d=[];return e.tickables.forEach(function(u){u.noteType==="n"?(s.addEvent(new I({pitch:u.keys.map(function(y,w){return i.convertPitch(y,w,u,n.addRenderedAccidentals)}),duration:i.convertDuration(u),wait:d})),d=[]):u.noteType==="r"&&d.push(i.convertDuration(u))}),d.length>0&&s.addEvent(new I({pitch:"[c4]",duration:"0",wait:d,velocity:"0"})),s},t.prototype.convertPitch=function(e,n,i,s){var d;s===void 0&&(s=!1);var u=e.split("/"),y=u[0].substring(1).replace("n","");return s&&((d=i.getAccidentals())===null||d===void 0||d.forEach(function(w){w.index===n&&(w.type==="n"?y="":y+=w.type)})),u[0][0]+y+u[1]},t.prototype.convertDuration=function(e){return"d".repeat(e.dots)+this.convertBaseDuration(e.duration)+(e.tuplet?"t"+e.tuplet.num_notes:"")},t.prototype.convertBaseDuration=function(e){switch(e){case"w":return"1";case"h":return"2";case"q":return"4";default:return e}},t}(),de=function(){function t(e){this.type=r.HEADER_CHUNK_TYPE;var n=e>1?r.HEADER_CHUNK_FORMAT1:r.HEADER_CHUNK_FORMAT0;this.data=n.concat(c.numberToBytes(e,2),r.HEADER_CHUNK_DIVISION),this.size=[0,0,0,this.data.length]}return t}(),he=function(){function t(e,n){n===void 0&&(n={}),this.tracks=c.toArray(e),this.options=n}return t.prototype.buildData=function(){var e=this,n=[];return n.push(new de(this.tracks.length)),this.tracks.forEach(function(i){n.push(i.buildData(e.options))}),n},t.prototype.buildFile=function(){var e=[];return this.buildData().forEach(function(n){return e=e.concat(n.type,n.size,n.data)}),new Uint8Array(e)},t.prototype.base64=function(){if(typeof btoa=="function"){for(var e="",n=this.buildFile(),i=n.byteLength,s=0;s<i;s++)e+=String.fromCharCode(n[s]);return btoa(e)}return Buffer.from(this.buildFile()).toString("base64")},t.prototype.dataUri=function(){return"data:audio/midi;base64,"+this.base64()},t.prototype.setOption=function(e,n){return this.options[e]=n,this},t.prototype.stdout=function(){return process.stdout.write(Buffer.from(this.buildFile()))},t}(),pe={Constants:r,ControllerChangeEvent:A,CopyrightEvent:J,CuePointEvent:Y,EndTrackEvent:H,InstrumentNameEvent:X,KeySignatureEvent:Z,LyricEvent:Q,MarkerEvent:ee,NoteOnEvent:M,NoteOffEvent:F,NoteEvent:I,PitchBendEvent:te,ProgramChangeEvent:ue,TempoEvent:O,TextEvent:ne,TimeSignatureEvent:re,Track:oe,TrackNameEvent:ie,Utils:c,VexFlow:le,Writer:he};return j=pe,j}var Te=Se();const G=xe(Te);function ke(r){const o={textarea:r.querySelector("#note-input-textarea"),renderButton:r.querySelector("#render-notes-button"),displayArea:r.querySelector("#note-sequence-display-area"),clefSelect:r.querySelector("#clef-select"),keySignatureSelect:r.querySelector("#key-signature-select"),timeSignatureSelect:r.querySelector("#time-signature-select"),examplesList:r.querySelector("#note-examples-list"),vexFlowTargetId:"note-seq-vexflow-output",playButton:r.querySelector(".play-button"),stopButton:r.querySelector(".stop-button"),bpmInput:r.querySelector("#bpm-input"),exportMidiButton:r.querySelector("#export-midi-button")};return!o.textarea||!o.renderButton||!o.displayArea||!o.clefSelect||!o.keySignatureSelect||!o.timeSignatureSelect||!o.examplesList?(console.error(l.t("noteSequenceRenderer.errors.uiElementMissing")),null):(o.vexFlowContainer=()=>r.querySelector(`#${o.vexFlowTargetId}`),o)}function $(r){if(!r)return[];const o={w:"w",1:"w",h:"h",2:"h",q:"q",4:"q",8:"8",16:"16",32:"32",64:"64"},a="q",p=/([A-Ga-g])(##|x|#|bb|b)?(\d)/i,v=/([A-Ga-g])(##|x|#|bb|b)?(\d)/gi,h=(g,b,m)=>{let x="";if(b){const S=b.toLowerCase();S==="##"||S==="x"?x="##":S==="bb"?x="bb":S==="#"?x="#":S==="b"&&(x="b")}return/^\d+$/.test(m)?`${g.toLowerCase()}${x}/${m}`:(console.warn(l.t("noteSequenceRenderer.warnings.invalidOctave",{octave:m,note:`${g}${b||""}${m}`})),null)},E=r.trim().split(/\s+/).filter(g=>g.length>0),T=[];let f=!1;return E.forEach(g=>{if(f)return;let b=g,m=a,x=0;if(g.includes("/")){const k=g.lastIndexOf("/");b=g.substring(0,k);let q=g.substring(k+1).toLowerCase();q.endsWith("d")&&(x=1,q=q.slice(0,-1));const R=o[q];if(R)m=R;else{console.warn(l.t("noteSequenceRenderer.warnings.unrecognizedDuration",{duration:g.substring(k+1),part:g})),f=!0;return}}const S=b.trim().toLowerCase();if(S==="r"||S==="z")T.push({keys:["b/4"],duration:m+"r",dots:x,isRest:!0});else{let k=[];const q=b.match(p);if(q&&q[0]===b){const[,R,C,B]=q,D=h(R,C,B);D?k.push(D):f=!0}else{let R,C=0,B=!1;for(v.lastIndex=0;(R=v.exec(b))!==null;){if(R.index!==C){f=!0,k=[];break}B=!0;const[,D,L,c]=R,A=h(D,L,c);if(A)k.push(A);else{f=!0,k=[];break}C=v.lastIndex}!f&&C!==b.length&&(f=!0,k=[]),!B&&!f&&(f=!0)}!f&&k.length>0&&T.push({keys:k,duration:m,dots:x,isRest:!1})}}),f?null:T}function Re(r){if(!r||typeof r.duration!="string")return console.error(l.t("noteSequenceRenderer.errors.invalidNoteInfo"),r),0;const o=r.duration.replace("r","");let a=0;switch(o){case"w":case"1":a=4;break;case"h":case"2":a=2;break;case"q":case"4":a=1;break;case"8":a=.5;break;case"16":a=.25;break;case"32":a=.125;break;case"64":a=.0625;break;default:return console.warn(l.t("noteSequenceRenderer.warnings.unknownDurationForValue",{duration:o}),r),0}return r.dots&&r.dots>0&&(a*=1.5),a}function qe(r){const o=r.toUpperCase();if(o==="FREE")return 1/0;if(o==="C"||o==="C|"||o==="2/2")return 4;if(r.includes("/"))try{const[a,p]=r.split("/"),v=parseInt(a,10),h=parseInt(p,10);if(!isNaN(v)&&!isNaN(h)&&h>0)return v*(4/h)}catch(a){console.error(l.t("noteSequenceRenderer.errors.timeSignatureParseError"),a)}return console.warn(l.t("noteSequenceRenderer.warnings.timeSignatureParse",{timeSignature:r})),4}function we(r,o){if(o.toUpperCase()==="FREE")return console.log(l.t("noteSequenceRenderer.logs.freeTimeSelected")),r;if(!r||r.length===0)return[];const a=qe(o);if(!isFinite(a)||a<=0)return console.warn(l.t("noteSequenceRenderer.warnings.invalidMeasureDuration")),r;const p=[];let v=0;const h=1e-4;return r.forEach((E,T)=>{p.push(E);const f=Re(E);v+=f,v>=a-h&&(T<r.length-1&&p.push({type:"barline",barType:"single"}),v-=a,Math.abs(v)<h&&(v=0))}),p}function z(r,o,a,p,v){let T=60;a&&a!=="C"&&(T+=30+(a.length-1)*8),p&&p.toUpperCase()!=="FREE"&&(T+=30);let f=0;r.forEach(b=>{b.type==="barline"?f+=10:f+=45});let g=T+f+20;return g=Math.max(300,g),{elementId:v,width:g,height:150,staves:[{clef:o,keySignature:a,timeSignature:p.toUpperCase()==="FREE"?void 0:p,notes:r}]}}function V(r,o){r?r.innerHTML=`<p style="color: red;">${o}</p>`:console.error(l.t("noteSequenceRenderer.errors.displayErrorFailed"),o)}function Ce(r){const{textarea:o,clefSelect:a,keySignatureSelect:p,timeSignatureSelect:v,displayArea:h,vexFlowTargetId:E,vexFlowContainer:T}=r;h.innerHTML=`<div id="${E}"></div>`;const f=T();if(!f){V(h,l.t("noteSequenceRenderer.errors.vexflowTargetError"));return}const g=o.value,b=a.value,m=p.value,x=v.value;try{const S=$(g);if(S===null){V(f,l.t("noteSequenceRenderer.errors.parseError"));const R=z([],b,m,x,E);W(R.elementId,R);return}const k=we(S,x),q=z(k,b,m,x,E);W(q.elementId,q),console.log(l.t("noteSequenceRenderer.logs.renderRequestProcessed"))}catch(S){console.error(l.t("noteSequenceRenderer.errors.unexpectedRenderError"),S),V(f,l.t("noteSequenceRenderer.errors.internalRenderError",{message:S.message}))}}function se(r){const o=r.duration.replace("r","");let a=0;switch(o){case"w":case"1":a=4;break;case"h":case"2":a=2;break;case"q":case"4":a=1;break;case"8":a=.5;break;case"16":a=.25;break;case"32":a=.125;break;case"64":a=.0625;break;default:return console.warn(l.t("noteSequenceRenderer.warnings.unknownDurationForBeat",{duration:o})),0}return r.dots&&r.dots>0&&(a*=1.5),a}function ce(r){if(!r||typeof r!="string")return null;const o=r.match(/([a-g])(##|x|#|bb|b)?\/?(\d)/i);if(!o)return r;const a=o[1].toUpperCase();let p=o[2]||"";p==="x"&&(p="##");const v=o[3];return`${a}${p}${v}`}function Ne(r){let o=0;const a=[];return r?(r.forEach(p=>{const v=se(p);if(!p.isRest&&p.keys&&p.keys.length>0){const h=p.keys.map(ce).filter(E=>E!==null);h.length>0&&a.push({type:"note",pitch:h.length===1?h[0]:h,startTime:o,duration:v})}o+=v}),a):[]}function Be(r,o){const a=se(r);return Math.round(a*o)}function De(r){try{const o=ce(r);return o?be(o).toMidi():null}catch(o){return console.warn(l.t("noteSequenceRenderer.warnings.midiConversionFailed",{vexKey:r}),o),null}}function Me(r,o,a,p){if(!r||r.length===0)return console.warn(l.t("noteSequenceRenderer.warnings.midiNoNotes")),null;const v=128;try{const h=new G.Track;if(h.setTempo(o),a&&a.toUpperCase()!=="FREE"&&a.includes("/"))try{const[f,g]=a.split("/").map(Number);!isNaN(f)&&!isNaN(g)&&h.setTimeSignature(f,g)}catch(f){console.warn(l.t("noteSequenceRenderer.warnings.midiTimeSignatureFailed"),f)}let E=0;return r.forEach(f=>{const g=Be(f,v);if(!f.isRest&&f.keys&&f.keys.length>0){const b=f.keys.map(De).filter(m=>m!==null);if(b.length>0){const m=new G.NoteEvent({pitch:b,duration:`T${g}`,startTick:E,velocity:100,sequential:!1});h.addEvent(m)}}E+=g}),new G.Writer([h]).dataUri()}catch(h){return console.error(l.t("noteSequenceRenderer.errors.midiGenerationError"),h),null}}function Ae(r,o){if(!r)return;const a=document.createElement("a");a.href=r,a.download=o,document.body.appendChild(a),a.click(),document.body.removeChild(a)}function Fe(r){r.renderButton?r.renderButton.addEventListener("click",()=>Ce(r)):console.error(l.t("noteSequenceRenderer.errors.renderButtonMissing")),r.playButton&&r.textarea&&r.bpmInput?r.playButton.addEventListener("click",async()=>{console.log(l.t("noteSequenceRenderer.logs.playButtonClicked"));try{await fe();const o=parseInt(r.bpmInput.value,10);if(isNaN(o)||o<30||o>500){alert(l.t("noteSequenceRenderer.alerts.invalidBpm")),console.error(l.t("noteSequenceRenderer.errors.invalidBpmValue"),r.bpmInput.value);return}const a=o,p=r.textarea.value,v=$(p);if(v===null){alert(l.t("noteSequenceRenderer.alerts.invalidNotesForPlayback")),console.error(l.t("noteSequenceRenderer.errors.parsingFailedForPlayback"));return}if(v.length===0){console.log(l.t("noteSequenceRenderer.logs.noNotesToPlay"));return}const h=Ne(v);if(console.log(l.t("noteSequenceRenderer.logs.audioEvents"),h),h.length===0&&v.length>0){console.log(l.t("noteSequenceRenderer.logs.noPlayableAudioEvents"));return}if(h.length===0){console.log(l.t("noteSequenceRenderer.logs.noAudioEventsGenerated"));return}ge(h,a),r.playButton.disabled=!0,r.stopButton.disabled=!1}catch(o){console.error(l.t("noteSequenceRenderer.errors.playbackSetupError"),o),alert(l.t("noteSequenceRenderer.alerts.playbackFailed",{message:o.message})),r.playButton&&(r.playButton.disabled=!1),r.stopButton&&(r.stopButton.disabled=!0)}}):console.warn(l.t("noteSequenceRenderer.warnings.playbackBindingFailed")),r.stopButton?(r.stopButton.disabled=!0,r.stopButton.addEventListener("click",()=>{console.log(l.t("noteSequenceRenderer.logs.stopButtonClicked")),Ee(),r.playButton&&(r.playButton.disabled=!1),r.stopButton.disabled=!0})):console.warn(l.t("noteSequenceRenderer.warnings.stopBindingFailed")),ye.on("stop",()=>{console.log(l.t("noteSequenceRenderer.logs.transportStopped")),r.playButton&&(r.playButton.disabled=!1),r.stopButton&&(r.stopButton.disabled=!0)}),r.exportMidiButton&&r.textarea&&r.bpmInput&&r.timeSignatureSelect&&r.keySignatureSelect?r.exportMidiButton.addEventListener("click",()=>{console.log(l.t("noteSequenceRenderer.logs.exportMidiClicked"));try{const o=r.textarea.value,a=parseInt(r.bpmInput.value,10),p=r.timeSignatureSelect.value,v=r.keySignatureSelect.value;if(isNaN(a)||a<30||a>500){alert(l.t("noteSequenceRenderer.alerts.invalidBpmMidi"));return}const h=$(o);if(h===null){alert(l.t("noteSequenceRenderer.alerts.invalidNotesForMidi"));return}if(h.length===0){alert(l.t("noteSequenceRenderer.alerts.noNotesForMidi"));return}const E=Me(h,a,p,v);E?(Ae(E,"music-sequence.mid"),console.log(l.t("noteSequenceRenderer.logs.midiExportInitiated"))):alert(l.t("noteSequenceRenderer.alerts.midiGenerationFailed"))}catch(o){console.error(l.t("noteSequenceRenderer.errors.midiExportError"),o),alert(l.t("noteSequenceRenderer.alerts.midiExportFailed",{message:o.message}))}}):console.warn(l.t("noteSequenceRenderer.warnings.midiBindingFailed"))}function _e(r){if(!r){console.error(l.t("noteSequenceRenderer.errors.initFailed"));return}r.innerHTML=me;const o=ke(r);if(o){Fe(o),o.examplesList&&o.textarea&&o.examplesList.addEventListener("click",a=>{if(a.target.classList.contains("example-input")){const p=a.target.textContent;o.textarea.value=p,o.textarea.focus(),console.log(l.t("noteSequenceRenderer.logs.exampleFilled",{exampleText:p}))}});try{o.displayArea.innerHTML=`<div id="${o.vexFlowTargetId}"><p>${l.t("noteSequenceRenderer.initialDisplayMessage")}</p></div>`;const a=o.vexFlowContainer();if(a){const p=o.keySignatureSelect.value,v=o.timeSignatureSelect.value,h=z([],o.clefSelect.value,p,v,o.vexFlowTargetId);a.innerHTML="",W(h.elementId,h)}else V(o.displayArea,l.t("noteSequenceRenderer.errors.initialVexflowTargetError"))}catch(a){console.error(l.t("noteSequenceRenderer.errors.initialRenderFailed"),a),V(o.displayArea,l.t("noteSequenceRenderer.errors.initialRenderFailedMessage",{message:a.message}))}console.log(l.t("noteSequenceRenderer.logs.initialized"))}}export{_e as initializeNoteSequenceRenderer};
