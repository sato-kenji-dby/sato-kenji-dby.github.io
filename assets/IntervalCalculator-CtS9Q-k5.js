import{i as o}from"./index-BVysS7N4.js";import{g as f,m as h,t as k}from"./index-B5kmyHN1.js";import{i as F,g as y,d as I,a as M,s as L}from"./index-sDpErw38.js";import{c as m}from"./vexflow-helper-BJ71SLUW.js";const $=`<!-- src/tools/IntervalCalculator/IntervalCalculator.html -->
<div class="tool-section interval-calculator-tool">
  <!-- 更通用的标题 -->
  <h3 data-i18n="intervalAnalyzerTitle"></h3>
  <!-- 更新描述，加入第三种格式 -->
  <p data-i18n="intervalAnalyzerDesc"></p>

  <div class="interval-input-area">
    <label for="interval-notes-input" data-i18n="inputLabel"></label>
    <!-- 更新 placeholder -->
    <input type="text" id="interval-notes-input" data-i18n-placeholder="inputPlaceholder">
    <!-- 更通用的按钮文本 -->
    <button id="calculate-interval-button" data-i18n="analyzeButton"></button>
    <button id="clear-interval-button" class="secondary-button" data-i18n="clearButton"></button>
  </div>

  <div id="interval-result-area" class="result-display-area">
      <p style="display: none;" data-i18n="resultsLabel"></p> <!-- 初始隐藏 -->
      <div id="interval-error-output" class="error-message"></div>
      <!-- 声部构建或多音符输入的音符显示 -->
      <div id="voicing-notes-output"></div>
      <!-- 新增：和弦检测结果显示 -->
      <div id="chord-detection-output"></div>
      <!-- 音程计算模式专用 -->
      <div id="interval-details-container" style="display: none;">
          <div id="interval-name-output"></div>
          <div id="interval-semitones-output"></div>
          <div id="interval-consonance-output"></div>
          <!-- 包裹两个选项的容器 -->
          <div class="interval-options-container">
              <div class="option-group">
                  <input type="checkbox" id="invert-interval-checkbox">
                  <label for="invert-interval-checkbox" data-i18n="showInversionLabel"></label>
              </div>
              <div class="option-group">
                  <input type="checkbox" id="simplify-interval-checkbox">
                  <label for="simplify-interval-checkbox" data-i18n="showSimplificationLabel"></label>
              </div>
          </div>
      </div>
  </div>

  <!-- VexFlow 显示容器 -->
  <div class="vexflow-display-container interval-score-container" style="display: none;">
      <div class="score-item">
          <!-- 标题将由 JS 动态设置 -->
          <h4 id="harmonic-title"></h4>
          <div id="harmonic-interval-score" class="vexflow-score-container" style="min-height: 150px;"></div>
      </div>
      <div class="score-item">
          <!-- 标题将由 JS 动态设置 -->
          <h4 id="melodic-title"></h4>
          <div id="melodic-interval-score" class="vexflow-score-container" style="min-height: 150px;"></div>
      </div>
  </div>
</div>
`;function P(t){const r={inputField:t.querySelector("#interval-notes-input"),calculateButton:t.querySelector("#calculate-interval-button"),clearIntervalButton:t.querySelector("#clear-interval-button"),resultArea:t.querySelector("#interval-result-area"),resultTitle:t.querySelector("#interval-result-area > p:first-child"),errorOutput:t.querySelector("#interval-error-output"),voicingNotesOutput:t.querySelector("#voicing-notes-output"),chordDetectionOutput:t.querySelector("#chord-detection-output"),intervalDetailsContainer:t.querySelector("#interval-details-container"),intervalNameOutput:t.querySelector("#interval-name-output"),semitonesOutput:t.querySelector("#interval-semitones-output"),consonanceOutput:t.querySelector("#interval-consonance-output"),invertCheckbox:t.querySelector("#invert-interval-checkbox"),simplifyCheckbox:t.querySelector("#simplify-interval-checkbox"),scoreContainer:t.querySelector(".vexflow-display-container"),harmonicScoreDiv:t.querySelector("#harmonic-interval-score"),melodicScoreDiv:t.querySelector("#melodic-interval-score"),harmonicTitle:t.querySelector("#harmonic-title"),melodicTitle:t.querySelector("#melodic-title")};return!r.inputField||!r.calculateButton||!r.errorOutput||!r.harmonicScoreDiv||!r.melodicScoreDiv?(console.error("乐理分析器错误: 缺少关键 UI 元素。"),null):((!r.chordDetectionOutput||!r.intervalDetailsContainer||!r.voicingNotesOutput)&&console.warn("乐理分析器警告: 部分结果显示区域未找到。"),r)}function E(t){const r=t.trim();if(!r)return{mode:null,data:null,error:o.t("errorInputEmpty")};const e=r.split(/\s+/).filter(c=>c);if(e.length<2)return{mode:null,data:null,error:o.t("errorNeedTwoParts")};const n=e[0],i=f(n);if(i.empty||i.oct===null)return{mode:null,data:null,error:o.t("errorInvalidBaseNote",{note:n})};const l=e[1],s=y(l),a=f(l);if(s.empty)if(!a.empty&&a.oct!==null){const c=[i.name];let u=null;for(let d=1;d<e.length;d++){const p=f(e[d]);if(p.empty||p.oct===null){u=e[d];break}c.push(p.name)}return u?{mode:null,data:null,error:o.t("errorInvalidNoteInInput",{note:u})}:c.length===2?{mode:"twoNotes",data:{notes:c},error:null}:(c.sort((d,p)=>(h(d)??1/0)-(h(p)??1/0)),{mode:"chordDetect",data:{notes:c},error:null})}else return e.length===2?{mode:null,data:null,error:o.t("errorUnrecognizedSecondPart",{part:l})}:{mode:null,data:null,error:o.t("errorUnrecognizedFormat")};else if(e.length===2){const c=U(i.name,l);return c.error?{mode:null,data:null,error:c.error}:{mode:"twoNotes",data:{notes:[i.name,c.note]},error:null}}else{const c=e.slice(1),u=c.filter(d=>y(d).empty);return u.length>0?{mode:null,data:null,error:o.t("errorInvalidIntervals",{intervals:u.join(", ")})}:{mode:"multiIntervalVoicing",data:{baseNote:i.name,intervals:c},error:null}}}function B(t){if(!t)return o.t("consonanceUnknown");const r=y(t);if(r.empty)return o.t("consonanceUnknown");const e=r.simple,n=r.q;return n==="P"&&[1,4,5,8].includes(e)?o.t("consonancePerfect"):(n==="M"||n==="m")&&[3,6].includes(e)?o.t("consonanceImperfect"):o.t("consonanceDissonant")}function A(t,r){try{let e=t,n=r;const i=h(t),l=h(r);if(i===null||l===null)return{props:null,error:o.t("errorMidiValue")};i>l&&(e=r,n=t);const s=M(e,n);if(!s||s==="")return{props:null,error:o.t("errorCannotCalculateInterval")};const a=y(s);return a.empty?{props:null,error:o.t("errorCannotParseInterval",{interval:s})}:{props:a,error:null}}catch(e){return console.error("计算音程时出错:",e),{props:null,error:o.t("errorDuringCalculation")}}}function H(t,r){console.log("calculateVoicingNotes - 输入:",{baseNote:t,intervalNames:r});const e=[];try{e.push(t);for(const n of r){const i=k(t,n),l=f(i);if(l.empty)return{notes:null,error:o.t("errorApplyingInterval",{baseNote:t,intervalName:n})};e.includes(l.name)||e.push(l.name)}return console.log("calculateVoicingNotes - 排序前:",[...e]),e.sort((n,i)=>(h(n)??1/0)-(h(i)??1/0)),console.log("calculateVoicingNotes - 排序后:",[...e]),{notes:e,error:null}}catch(n){return console.error("构建声部时出错:",n),{notes:null,error:o.t("errorBuildingVoicing",{message:n.message})}}}function S(t){if(!t||t.length<2)return{chords:[],error:o.t("errorNeedTwoNotesForChord")};try{return typeof I!="function"?(console.error("detectChordFromNotes - ERROR: Chord.detect 不是一个函数!"),{chords:[],error:o.t("errorChordDetectionFunction")}):{chords:I(t),error:null}}catch(r){return console.error("detectChordFromNotes - ERROR during Chord.detect:",r),{chords:[],error:o.t("errorDuringChordDetection",{message:r.message})}}}function U(t,r){try{const e=k(t,r),n=f(e);return n.empty?{note:null,error:o.t("errorInvalidTransposition",{intervalName:r,baseNote:t})}:{note:n.name,error:null}}catch(e){return console.error("计算单音程移调时出错:",e),{note:null,error:o.t("errorDuringTransposition",{message:e.message})}}}function b(t){const r=f(t);if(r.empty||r.oct===null)return null;let e="";return r.acc==="b"?e="b":r.acc==="#"?e="#":r.acc==="bb"?e="bb":(r.acc==="x"||r.acc==="##")&&(e="##"),`${r.letter.toLowerCase()}${e}/${r.oct}`}function N(t){if(!t||t.length===0)return"treble";const r=t.map(n=>h(n)).filter(n=>n!==null);return r.length===0||r.reduce((n,i)=>n+i,0)/r.length>=60?"treble":"bass"}function z(t,r,e,n=!1){if(!t||!t.harmonicScoreDiv||!t.melodicScoreDiv){console.error("渲染音程谱例错误：缺少 elements 或 score divs。"),t&&t.errorOutput&&(t.errorOutput.textContent=o.t("errorRenderInternal"));return}const i=b(r),l=b(e);if(!i||!l){console.error("无法为 VexFlow 准备 keys:",r,e),t.errorOutput&&(t.errorOutput.textContent=o.t("errorRenderInvalidNote"));return}const s=t.harmonicScoreDiv.id,a=t.melodicScoreDiv.id;if(!s||!a){console.error("渲染错误：VexFlow 容器缺少 ID。"),t.errorOutput&&(t.errorOutput.textContent=o.t("errorRenderMissingId"));return}t.harmonicTitle.textContent=o.t("harmonicInterval"),t.melodicTitle.textContent=o.t("melodicInterval"),t.harmonicTitle.style.display="block",t.melodicTitle.style.display="block";const c=N([r,e]);t.harmonicScoreDiv.innerHTML="",t.melodicScoreDiv.innerHTML="";const u={elementId:s,width:150,height:150,staves:[{clef:c,notes:[{keys:[i,l].sort(),duration:"w"}]}]},d={elementId:a,width:200,height:150,staves:[{clef:c,notes:[{keys:[i],duration:"h"},{keys:[l],duration:"h"}]}]};try{m(s,u),m(a,d)}catch(p){console.error("渲染音程谱例出错:",p),t.errorOutput&&(t.errorOutput.textContent=o.t("errorRenderGeneric",{message:p.message}))}}function K(t,r){if(console.log("renderVoicingScores - 接收到的音符:",[...r]),!t||!t.harmonicScoreDiv||!t.melodicScoreDiv){console.error("渲染声部谱例错误：缺少 elements 或 score divs。"),t&&t.errorOutput&&(t.errorOutput.textContent=o.t("errorRenderInternal"));return}if(!r||r.length<1){console.error("渲染声部谱例错误：无效的音符数组。"),t&&t.errorOutput&&(t.errorOutput.textContent=o.t("errorRenderNoValidNotes"));return}const e=r.map(b).filter(u=>u);if(e.length!==r.length){console.error("部分音符无法转换为 VexFlow keys:",r),t&&t.errorOutput&&(t.errorOutput.textContent=o.t("errorRenderPartialInvalid"));return}const n=t.harmonicScoreDiv.id,i=t.melodicScoreDiv.id;if(!n||!i){console.error("渲染错误：VexFlow 容器缺少 ID。"),t.errorOutput&&(t.errorOutput.textContent=o.t("errorRenderMissingId"));return}t.harmonicTitle.textContent=o.t("harmonicVoicing"),t.melodicTitle.textContent=o.t("melodicSequence"),t.harmonicTitle.style.display="block",t.melodicTitle.style.display="block";const l=N(r);t.harmonicScoreDiv.innerHTML="",t.melodicScoreDiv.innerHTML="";const s={elementId:n,width:Math.max(150,40+e.length*20),height:150,staves:[{clef:l,notes:[{keys:e.slice().sort(),duration:"w"}]}]},a=e.map(u=>({keys:[u],duration:"q"})),c={elementId:i,width:Math.max(200,60+a.length*40),height:150,staves:[{clef:l,timeSignature:`${a.length}/4`,notes:a}]};a.length>8?(c.staves[0].timeSignature="4/4",c.width=Math.max(300,60+a.length*30)):a.length>0&&(c.staves[0].timeSignature=`${a.length}/4`);try{m(n,s),m(i,c)}catch(u){console.error("渲染 VexFlow 谱例时出错:",u),t.errorOutput&&(t.errorOutput.textContent=o.t("errorRenderVexflow",{message:u.message})),t.harmonicTitle.style.display="none",t.melodicTitle.style.display="none"}}function x(t){t&&(t.errorOutput.textContent="",t.errorOutput.style.display="none",t.voicingNotesOutput.textContent="",t.chordDetectionOutput&&(t.chordDetectionOutput.textContent=""),t.intervalDetailsContainer&&(t.intervalDetailsContainer.style.display="none"),t.intervalNameOutput.textContent="",t.semitonesOutput.textContent="",t.consonanceOutput.textContent="",t.scoreContainer&&(t.scoreContainer.style.display="none"),t.harmonicScoreDiv.innerHTML="",t.melodicScoreDiv.innerHTML="",t.harmonicTitle&&(t.harmonicTitle.style.display="none"),t.melodicTitle&&(t.melodicTitle.style.display="none"),t.resultTitle&&(t.resultTitle.style.display="none"))}function v(t,r){x(t),t.errorOutput.textContent=o.t("errorGeneric",{message:r}),t.errorOutput.style.display="block"}function j(t,r,e,n,i){if(x(t),!r||r.empty){v(t,o.t("errorInvalidIntervalProps"));return}t.resultTitle&&(t.resultTitle.style.display="block");const l=r.q,s=r.num,c=`${r.dir===-1?"-":""}${l}${s}`,u=r.semitones,d=B(r.name),p=Math.abs(r.num)>8;let g=o.t("intervalName",{name:c});if(n&&(g+=o.t("inverted")),i&&p){const w=L(r.name),C=y(w);if(C.empty)g+=o.t("cannotSimplify");else{const R=C.q,V=C.num,q=`${C.dir===-1?"-":""}${R}${V}`;g+=o.t("simplified",{name:q})}}t.intervalNameOutput.textContent=g,t.semitonesOutput.textContent=`${o.t("semitones",{count:u})}${n?o.t("inverted"):""}`,t.consonanceOutput.textContent=`${o.t("consonance",{type:d})}${n?o.t("inverted"):""}`,t.intervalDetailsContainer&&(t.intervalDetailsContainer.style.display="block"),e&&e.length===2&&t.scoreContainer&&(t.scoreContainer.style.display="flex",z(t,e[0],e[1],n))}function D(t,r,e){if(x(t),!e||e.length===0){v(t,o.t("errorNoValidInputNotes"));return}if(t.resultTitle&&(t.resultTitle.style.display="block"),t.intervalDetailsContainer&&(t.intervalDetailsContainer.style.display="none"),!t.voicingNotesOutput||!t.chordDetectionOutput){console.error("displayChordResult - ERROR: UI 元素缺失 (voicingNotesOutput 或 chordDetectionOutput)");return}t.voicingNotesOutput.textContent=o.t("relatedNotes",{notes:e.join(" ")}),r&&r.length>0?t.chordDetectionOutput.textContent=o.t("detectedChords",{chords:r.join(", ")}):t.chordDetectionOutput.textContent=o.t("noChordsDetected"),t.scoreContainer?t.harmonicScoreDiv&&t.melodicScoreDiv?(t.scoreContainer.style.display="flex",K(t,e)):console.error("displayChordResult - ERROR: scoreContainer 内的谱例元素缺失！"):console.warn("displayChordResult - WARN: scoreContainer 元素未找到。")}function T(t){t&&(t.inputField.value="",x(t),t.invertCheckbox&&(t.invertCheckbox.checked=!1),t.simplifyCheckbox&&(t.simplifyCheckbox.checked=!1),console.log("输入和结果已清除。"))}function O(t){if(!t)return;const r=t.inputField.value,e=E(r);if(e.error){v(t,e.error);return}switch(e.mode){case"twoNotes":{const{notes:n}=e.data,i=t.invertCheckbox?t.invertCheckbox.checked:!1,l=t.simplifyCheckbox?t.simplifyCheckbox.checked:!1;let s=null,a=null;const c=A(n[0],n[1]);if(c.error)a=c.error;else if(!c.props||c.props.empty)console.error("handleCalculation - twoNotes - 原始计算结果无效但没有错误信息:",c),a=o.t("errorOriginalInterval");else if(i)try{const u=F(c.props.name);if(!u||u==="")console.error("handleCalculation - twoNotes - Interval.invert 返回空!"),a=o.t("errorInvertFailed");else{const d=y(u);!d||d.empty?(console.error("handleCalculation - twoNotes - 获取转位属性失败!"),a=o.t("errorInvertedProps")):s=d}}catch(u){console.error("handleCalculation - twoNotes - 转位计算异常:",u),a=o.t("errorInversionCalculation",{message:u.message})}else s=c.props;a?v(t,a):s&&!s.empty?j(t,s,n,i,l):(console.error("handleCalculation - twoNotes - 最终状态异常：无错误但结果无效。"),v(t,o.t("errorFinalCheck")));break}case"multiIntervalVoicing":{const{baseNote:n,intervals:i}=e.data,l=H(n,i);if(l.error)v(t,l.error);else if(!l.notes||l.notes.length===0)console.error("handleCalculation - multiIntervalVoicing - voicingResult.notes 无效"),v(t,o.t("errorInvalidNoteList"));else{const s=S(l.notes);s.error?v(t,s.error):D(t,s.chords,l.notes)}break}case"chordDetect":{const{notes:n}=e.data,i=S(n);i.error?v(t,i.error):D(t,i.chords,n);break}default:v(t,o.t("errorUnknownMode"))}}function G(t){if(!t)return;t.calculateButton&&t.calculateButton.addEventListener("click",()=>O(t)),t.clearIntervalButton&&t.clearIntervalButton.addEventListener("click",()=>T(t)),t.inputField;const r=()=>{const n=(t.inputField?t.inputField.value:"").trim().split(/\s+/).filter(l=>l);let i=!1;if(n.length===2){const l=f(n[0]),s=f(n[1]),a=y(n[1]);!l.empty&&l.oct!==null&&(!s.empty&&s.oct!==null?i=!0:a.empty||(i=!0))}i?(console.log("Option changed, recalculating for interval mode."),O(t)):console.log("Option changed, but not in interval mode. No recalculation.")};t.invertCheckbox&&t.invertCheckbox.addEventListener("change",r),t.simplifyCheckbox&&t.simplifyCheckbox.addEventListener("change",r)}function Z(t){if(!t){console.error("乐理分析器初始化失败: 未提供容器元素。");return}t.innerHTML=$;const r=P(t);r&&(G(r),T(r),console.log("乐理分析器工具已初始化 (支持音程/声部/和弦)。"))}export{Z as initializeIntervalCalculator};
