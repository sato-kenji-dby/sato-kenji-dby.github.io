import{c as T}from"./vexflow-helper-BU9dFy0f.js";import{n as y,i as X,t as k,g as x,p as j,a as J}from"./index-DJj0RTVl.js";const Y=`<!-- src/tools/ScaleExplorer/ScaleExplorer.html -->
<div class="tool-section scale-explorer-tool">
    <h3>音阶浏览器 (Scale Explorer)</h3>
    <p>选择一个根音和音阶类型，或点击“随机”来探索各种音阶。</p>
  
    <div class="scale-options">
      <div class="option-group">
        <label for="tonic-input">根音 (Tonic):</label>
        <input type="text" id="tonic-input" placeholder="例如: C4, Ab, F#" value="C4">
      </div>
  
      <div class="option-group">
        <label for="scale-select">音阶类型 (Scale Type):</label>
        <select id="scale-select">
          <option value="">-- 加载中 --</option>
        </select>
      </div>
       <div class="option-group">
        <label for="scale-clef-select">谱号 (Clef):</label>
        <select id="scale-clef-select">
          <option value="treble" selected>高音 (Treble)</option>
          <option value="bass">低音 (Bass)</option>
          <option value="alto">中音 (Alto)</option>
          <option value="tenor">次中音 (Tenor)</option>
        </select>
      </div>
      <!-- Buttons Group -->
      <div class="button-group">
          <button id="generate-scale-button">生成音阶</button>
          <button id="randomize-scale-button">随机生成</button> <!-- New Randomize Button -->
      </div>
    </div>
  
    <div class="output-section">
      <!-- Combined Notes Output -->
      <h4>音阶构成音 (Characteristic notes in bold):</h4>
      <div id="scale-notes-output" class="code-output">
        <p>选择参数后点击生成。</p>
      </div>
  
      <!-- Usage Suggestion Area -->
      <h4>调式特点与建议:</h4>
      <div id="scale-usage-output" class="usage-suggestion">
          <p>-</p>
      </div>
  
      <h4>乐谱渲染:</h4>
      <div id="scale-score-output" class="vexflow-score-container" style="min-height: 150px;">
        <p>乐谱将在此处显示。</p>
      </div>
    </div>
  
  </div>`;function O(e,n){const t=n.length,o=(e%t+t)%t;return n.slice(o,t).concat(n.slice(0,o))}function I(e,n=Math.random){let t,o,m=e.length;for(;m;)t=Math.floor(n()*m--),o=e[m],e[m]=e[t],e[t]=o;return e}var c={empty:!0,name:"",setNum:0,chroma:"000000000000",normalized:"000000000000",intervals:[]},D=e=>Number(e).toString(2).padStart(12,"0"),L=e=>parseInt(e,2),Z=/^[01]{12}$/;function V(e){return Z.test(e)}var ee=e=>typeof e=="number"&&e>=0&&e<=4095,ne=e=>e&&V(e.chroma),q={[c.chroma]:c};function B(e){const n=V(e)?e:ee(e)?D(e):Array.isArray(e)?ie(e):ne(e)?e.chroma:c.chroma;return q[n]=q[n]||ae(n)}var te=["1P","2m","2M","3m","3M","4P","5d","5P","6m","6M","7m","7M"];function oe(e){const n=[];for(let t=0;t<12;t++)e.charAt(t)==="1"&&n.push(te[t]);return n}function me(e){const n=e.split("");return n.map((t,o)=>O(o,n).join(""))}function ae(e){const n=L(e),t=me(e).map(L).filter(a=>a>=2048).sort()[0],o=D(t),m=oe(e);return{empty:!1,name:"",setNum:n,chroma:e,normalized:o,intervals:m}}function ie(e){if(e.length===0)return c.chroma;let n;const t=[0,0,0,0,0,0,0,0,0,0,0,0];for(let o=0;o<e.length;o++)n=y(e[o]),n.empty&&(n=X(e[o])),n.empty||(t[n.chroma]=1);return t.join("")}var re=[["1P 3M 5P","major","M ^  maj"],["1P 3M 5P 7M","major seventh","maj7 Δ ma7 M7 Maj7 ^7"],["1P 3M 5P 7M 9M","major ninth","maj9 Δ9 ^9"],["1P 3M 5P 7M 9M 13M","major thirteenth","maj13 Maj13 ^13"],["1P 3M 5P 6M","sixth","6 add6 add13 M6"],["1P 3M 5P 6M 9M","sixth added ninth","6add9 6/9 69 M69"],["1P 3M 6m 7M","major seventh flat sixth","M7b6 ^7b6"],["1P 3M 5P 7M 11A","major seventh sharp eleventh","maj#4 Δ#4 Δ#11 M7#11 ^7#11 maj7#11"],["1P 3m 5P","minor","m min -"],["1P 3m 5P 7m","minor seventh","m7 min7 mi7 -7"],["1P 3m 5P 7M","minor/major seventh","m/ma7 m/maj7 mM7 mMaj7 m/M7 -Δ7 mΔ -^7 -maj7"],["1P 3m 5P 6M","minor sixth","m6 -6"],["1P 3m 5P 7m 9M","minor ninth","m9 -9"],["1P 3m 5P 7M 9M","minor/major ninth","mM9 mMaj9 -^9"],["1P 3m 5P 7m 9M 11P","minor eleventh","m11 -11"],["1P 3m 5P 7m 9M 13M","minor thirteenth","m13 -13"],["1P 3m 5d","diminished","dim ° o"],["1P 3m 5d 7d","diminished seventh","dim7 °7 o7"],["1P 3m 5d 7m","half-diminished","m7b5 ø -7b5 h7 h"],["1P 3M 5P 7m","dominant seventh","7 dom"],["1P 3M 5P 7m 9M","dominant ninth","9"],["1P 3M 5P 7m 9M 13M","dominant thirteenth","13"],["1P 3M 5P 7m 11A","lydian dominant seventh","7#11 7#4"],["1P 3M 5P 7m 9m","dominant flat ninth","7b9"],["1P 3M 5P 7m 9A","dominant sharp ninth","7#9"],["1P 3M 7m 9m","altered","alt7"],["1P 4P 5P","suspended fourth","sus4 sus"],["1P 2M 5P","suspended second","sus2"],["1P 4P 5P 7m","suspended fourth seventh","7sus4 7sus"],["1P 5P 7m 9M 11P","eleventh","11"],["1P 4P 5P 7m 9m","suspended fourth flat ninth","b9sus phryg 7b9sus 7b9sus4"],["1P 5P","fifth","5"],["1P 3M 5A","augmented","aug + +5 ^#5"],["1P 3m 5A","minor augmented","m#5 -#5 m+"],["1P 3M 5A 7M","augmented seventh","maj7#5 maj7+5 +maj7 ^7#5"],["1P 3M 5P 7M 9M 11A","major sharp eleventh (lydian)","maj9#11 Δ9#11 ^9#11"],["1P 2M 4P 5P","","sus24 sus4add9"],["1P 3M 5A 7M 9M","","maj9#5 Maj9#5"],["1P 3M 5A 7m","","7#5 +7 7+ 7aug aug7"],["1P 3M 5A 7m 9A","","7#5#9 7#9#5 7alt"],["1P 3M 5A 7m 9M","","9#5 9+"],["1P 3M 5A 7m 9M 11A","","9#5#11"],["1P 3M 5A 7m 9m","","7#5b9 7b9#5"],["1P 3M 5A 7m 9m 11A","","7#5b9#11"],["1P 3M 5A 9A","","+add#9"],["1P 3M 5A 9M","","M#5add9 +add9"],["1P 3M 5P 6M 11A","","M6#11 M6b5 6#11 6b5"],["1P 3M 5P 6M 7M 9M","","M7add13"],["1P 3M 5P 6M 9M 11A","","69#11"],["1P 3m 5P 6M 9M","","m69 -69"],["1P 3M 5P 6m 7m","","7b6"],["1P 3M 5P 7M 9A 11A","","maj7#9#11"],["1P 3M 5P 7M 9M 11A 13M","","M13#11 maj13#11 M13+4 M13#4"],["1P 3M 5P 7M 9m","","M7b9"],["1P 3M 5P 7m 11A 13m","","7#11b13 7b5b13"],["1P 3M 5P 7m 13M","","7add6 67 7add13"],["1P 3M 5P 7m 9A 11A","","7#9#11 7b5#9 7#9b5"],["1P 3M 5P 7m 9A 11A 13M","","13#9#11"],["1P 3M 5P 7m 9A 11A 13m","","7#9#11b13"],["1P 3M 5P 7m 9A 13M","","13#9"],["1P 3M 5P 7m 9A 13m","","7#9b13"],["1P 3M 5P 7m 9M 11A","","9#11 9+4 9#4"],["1P 3M 5P 7m 9M 11A 13M","","13#11 13+4 13#4"],["1P 3M 5P 7m 9M 11A 13m","","9#11b13 9b5b13"],["1P 3M 5P 7m 9m 11A","","7b9#11 7b5b9 7b9b5"],["1P 3M 5P 7m 9m 11A 13M","","13b9#11"],["1P 3M 5P 7m 9m 11A 13m","","7b9b13#11 7b9#11b13 7b5b9b13"],["1P 3M 5P 7m 9m 13M","","13b9"],["1P 3M 5P 7m 9m 13m","","7b9b13"],["1P 3M 5P 7m 9m 9A","","7b9#9"],["1P 3M 5P 9M","","Madd9 2 add9 add2"],["1P 3M 5P 9m","","Maddb9"],["1P 3M 5d","","Mb5"],["1P 3M 5d 6M 7m 9M","","13b5"],["1P 3M 5d 7M","","M7b5"],["1P 3M 5d 7M 9M","","M9b5"],["1P 3M 5d 7m","","7b5"],["1P 3M 5d 7m 9M","","9b5"],["1P 3M 7m","","7no5"],["1P 3M 7m 13m","","7b13"],["1P 3M 7m 9M","","9no5"],["1P 3M 7m 9M 13M","","13no5"],["1P 3M 7m 9M 13m","","9b13"],["1P 3m 4P 5P","","madd4"],["1P 3m 5P 6m 7M","","mMaj7b6"],["1P 3m 5P 6m 7M 9M","","mMaj9b6"],["1P 3m 5P 7m 11P","","m7add11 m7add4"],["1P 3m 5P 9M","","madd9"],["1P 3m 5d 6M 7M","","o7M7"],["1P 3m 5d 7M","","oM7"],["1P 3m 6m 7M","","mb6M7"],["1P 3m 6m 7m","","m7#5"],["1P 3m 6m 7m 9M","","m9#5"],["1P 3m 5A 7m 9M 11P","","m11A"],["1P 3m 6m 9m","","mb6b9"],["1P 2M 3m 5d 7m","","m9b5"],["1P 4P 5A 7M","","M7#5sus4"],["1P 4P 5A 7M 9M","","M9#5sus4"],["1P 4P 5A 7m","","7#5sus4"],["1P 4P 5P 7M","","M7sus4"],["1P 4P 5P 7M 9M","","M9sus4"],["1P 4P 5P 7m 9M","","9sus4 9sus"],["1P 4P 5P 7m 9M 13M","","13sus4 13sus"],["1P 4P 5P 7m 9m 13m","","7sus4b9b13 7b9b13sus4"],["1P 4P 7m 10m","","4 quartal"],["1P 5P 7m 9m 11P","","11b9"]],se=re;({...c});var F=[],A={};function Pe(e,n,t){const o=Me(e),m={...B(e),name:t||"",quality:o,intervals:e,aliases:n};F.push(m),m.name&&(A[m.name]=m),A[m.setNum]=m,A[m.chroma]=m,m.aliases.forEach(a=>le(m,a))}function le(e,n){A[n]=e}function Me(e){const n=t=>e.indexOf(t)!==-1;return n("5A")?"Augmented":n("3M")?"Major":n("5d")?"Diminished":n("3m")?"Minor":"Unknown"}se.forEach(([e,n,t])=>Pe(e.split(" "),t.split(" "),n));F.sort((e,n)=>e.setNum-n.setNum);var ce=[["1P 2M 3M 5P 6M","major pentatonic","pentatonic"],["1P 2M 3M 4P 5P 6M 7M","major","ionian"],["1P 2M 3m 4P 5P 6m 7m","minor","aeolian"],["1P 2M 3m 3M 5P 6M","major blues"],["1P 3m 4P 5d 5P 7m","minor blues","blues"],["1P 2M 3m 4P 5P 6M 7M","melodic minor"],["1P 2M 3m 4P 5P 6m 7M","harmonic minor"],["1P 2M 3M 4P 5P 6M 7m 7M","bebop"],["1P 2M 3m 4P 5d 6m 6M 7M","diminished","whole-half diminished"],["1P 2M 3m 4P 5P 6M 7m","dorian"],["1P 2M 3M 4A 5P 6M 7M","lydian"],["1P 2M 3M 4P 5P 6M 7m","mixolydian","dominant"],["1P 2m 3m 4P 5P 6m 7m","phrygian"],["1P 2m 3m 4P 5d 6m 7m","locrian"],["1P 3M 4P 5P 7M","ionian pentatonic"],["1P 3M 4P 5P 7m","mixolydian pentatonic","indian"],["1P 2M 4P 5P 6M","ritusen"],["1P 2M 4P 5P 7m","egyptian"],["1P 3M 4P 5d 7m","neopolitan major pentatonic"],["1P 3m 4P 5P 6m","vietnamese 1"],["1P 2m 3m 5P 6m","pelog"],["1P 2m 4P 5P 6m","kumoijoshi"],["1P 2M 3m 5P 6m","hirajoshi"],["1P 2m 4P 5d 7m","iwato"],["1P 2m 4P 5P 7m","in-sen"],["1P 3M 4A 5P 7M","lydian pentatonic","chinese"],["1P 3m 4P 6m 7m","malkos raga"],["1P 3m 4P 5d 7m","locrian pentatonic","minor seven flat five pentatonic"],["1P 3m 4P 5P 7m","minor pentatonic","vietnamese 2"],["1P 3m 4P 5P 6M","minor six pentatonic"],["1P 2M 3m 5P 6M","flat three pentatonic","kumoi"],["1P 2M 3M 5P 6m","flat six pentatonic"],["1P 2m 3M 5P 6M","scriabin"],["1P 3M 5d 6m 7m","whole tone pentatonic"],["1P 3M 4A 5A 7M","lydian #5P pentatonic"],["1P 3M 4A 5P 7m","lydian dominant pentatonic"],["1P 3m 4P 5P 7M","minor #7M pentatonic"],["1P 3m 4d 5d 7m","super locrian pentatonic"],["1P 2M 3m 4P 5P 7M","minor hexatonic"],["1P 2A 3M 5P 5A 7M","augmented"],["1P 2M 4P 5P 6M 7m","piongio"],["1P 2m 3M 4A 6M 7m","prometheus neopolitan"],["1P 2M 3M 4A 6M 7m","prometheus"],["1P 2m 3M 5d 6m 7m","mystery #1"],["1P 2m 3M 4P 5A 6M","six tone symmetric"],["1P 2M 3M 4A 5A 6A","whole tone","messiaen's mode #1"],["1P 2m 4P 4A 5P 7M","messiaen's mode #5"],["1P 2M 3M 4P 5d 6m 7m","locrian major","arabian"],["1P 2m 3M 4A 5P 6m 7M","double harmonic lydian"],["1P 2m 2A 3M 4A 6m 7m","altered","super locrian","diminished whole tone","pomeroy"],["1P 2M 3m 4P 5d 6m 7m","locrian #2","half-diminished","aeolian b5"],["1P 2M 3M 4P 5P 6m 7m","mixolydian b6","melodic minor fifth mode","hindu"],["1P 2M 3M 4A 5P 6M 7m","lydian dominant","lydian b7","overtone"],["1P 2M 3M 4A 5A 6M 7M","lydian augmented"],["1P 2m 3m 4P 5P 6M 7m","dorian b2","phrygian #6","melodic minor second mode"],["1P 2m 3m 4d 5d 6m 7d","ultralocrian","superlocrian bb7","superlocrian diminished"],["1P 2m 3m 4P 5d 6M 7m","locrian 6","locrian natural 6","locrian sharp 6"],["1P 2A 3M 4P 5P 5A 7M","augmented heptatonic"],["1P 2M 3m 4A 5P 6M 7m","dorian #4","ukrainian dorian","romanian minor","altered dorian"],["1P 2M 3m 4A 5P 6M 7M","lydian diminished"],["1P 2M 3M 4A 5A 7m 7M","leading whole tone"],["1P 2M 3M 4A 5P 6m 7m","lydian minor"],["1P 2m 3M 4P 5P 6m 7m","phrygian dominant","spanish","phrygian major"],["1P 2m 3m 4P 5P 6m 7M","balinese"],["1P 2m 3m 4P 5P 6M 7M","neopolitan major"],["1P 2M 3M 4P 5P 6m 7M","harmonic major"],["1P 2m 3M 4P 5P 6m 7M","double harmonic major","gypsy"],["1P 2M 3m 4A 5P 6m 7M","hungarian minor"],["1P 2A 3M 4A 5P 6M 7m","hungarian major"],["1P 2m 3M 4P 5d 6M 7m","oriental"],["1P 2m 3m 3M 4A 5P 7m","flamenco"],["1P 2m 3m 4A 5P 6m 7M","todi raga"],["1P 2m 3M 4P 5d 6m 7M","persian"],["1P 2m 3M 5d 6m 7m 7M","enigmatic"],["1P 2M 3M 4P 5A 6M 7M","major augmented","major #5","ionian augmented","ionian #5"],["1P 2A 3M 4A 5P 6M 7M","lydian #9"],["1P 2m 2M 4P 4A 5P 6m 7M","messiaen's mode #4"],["1P 2m 3M 4P 4A 5P 6m 7M","purvi raga"],["1P 2m 3m 3M 4P 5P 6m 7m","spanish heptatonic"],["1P 2M 3m 3M 4P 5P 6M 7m","bebop minor"],["1P 2M 3M 4P 5P 5A 6M 7M","bebop major"],["1P 2m 3m 4P 5d 5P 6m 7m","bebop locrian"],["1P 2M 3m 4P 5P 6m 7m 7M","minor bebop"],["1P 2M 3M 4P 5d 5P 6M 7M","ichikosucho"],["1P 2M 3m 4P 5P 6m 6M 7M","minor six diminished"],["1P 2m 3m 3M 4A 5P 6M 7m","half-whole diminished","dominant diminished","messiaen's mode #2"],["1P 3m 3M 4P 5P 6M 7m 7M","kafi raga"],["1P 2M 3M 4P 4A 5A 6A 7M","messiaen's mode #6"],["1P 2M 3m 3M 4P 5d 5P 6M 7m","composite blues"],["1P 2M 3m 3M 4A 5P 6m 7m 7M","messiaen's mode #3"],["1P 2m 2M 3m 4P 4A 5P 6m 6M 7M","messiaen's mode #7"],["1P 2m 2M 3m 3M 4P 5d 5P 6m 6M 7m 7M","chromatic"]],de=ce,ue={...c,intervals:[],aliases:[]},R=[],f={};function pe(){return R.map(e=>e.name)}function G(e){return f[e]||ue}function he(e,n,t=[]){const o={...B(e),name:n,intervals:e,aliases:t};return R.push(o),f[o.name]=o,f[o.setNum]=o,f[o.chroma]=o,o.aliases.forEach(m=>be(o,m)),o}function be(e,n){f[n]=e}de.forEach(([e,n,...t])=>he(e.split(" "),n,t));var fe=[[.125,"dl",["large","duplex longa","maxima","octuple","octuple whole"]],[.25,"l",["long","longa"]],[.5,"d",["double whole","double","breve"]],[1,"w",["whole","semibreve"]],[2,"h",["half","minim"]],[4,"q",["quarter","crotchet"]],[8,"e",["eighth","quaver"]],[16,"s",["sixteenth","semiquaver"]],[32,"t",["thirty-second","demisemiquaver"]],[64,"sf",["sixty-fourth","hemidemisemiquaver"]],[128,"h",["hundred twenty-eighth"]],[256,"th",["two hundred fifty-sixth"]]],ve=fe;ve.forEach(([e,n,t])=>void 0);var C=[[0,2773,0,"ionian","","Maj7","major"],[1,2902,2,"dorian","m","m7"],[2,3418,4,"phrygian","m","m7"],[3,2741,-1,"lydian","","Maj7"],[4,2774,1,"mixolydian","","7"],[5,2906,3,"aeolian","m","m7","minor"],[6,3434,5,"locrian","dim","m7b5"]],H={...c,name:"",alt:0,modeNum:NaN,triad:"",seventh:"",aliases:[]},ge=C.map(Ae),N={};ge.forEach(e=>{N[e.name]=e,e.aliases.forEach(n=>{N[n]=e})});function U(e){return typeof e=="string"?N[e.toLowerCase()]||H:e&&e.name?U(e.name):H}function Ae(e){const[n,t,o,m,a,r,i]=e,p=i?[i]:[],P=Number(t).toString(2);return{empty:!1,intervals:G(m).intervals,modeNum:n,chroma:P,normalized:P,name:m,setNum:t,alt:o,triad:a,seventh:r,aliases:p}}function _(e){return(n,t)=>{const o=U(n);if(o.empty)return[];const m=O(o.modeNum,e),a=o.intervals.map(r=>k(t,r));return m.map((r,i)=>a[i]+r)}}_(C.map(e=>e[4]));_(C.map(e=>e[5]));var ye={empty:!0,name:"",type:"",tonic:null,setNum:NaN,chroma:"",normalized:"",aliases:[],notes:[],intervals:[]};function xe(e){if(typeof e!="string")return["",""];const n=e.indexOf(" "),t=y(e.substring(0,n));if(t.empty){const m=y(e);return m.empty?["",e.toLowerCase()]:[m.name,""]}const o=e.substring(t.name.length+1).toLowerCase();return[t.name,o.length?o:""]}var je=pe;function z(e){const n=Array.isArray(e)?e:xe(e),t=y(n[0]).name,o=G(n[1]);if(o.empty)return ye;const m=o.name,a=t?o.intervals.map(i=>k(t,i)):[],r=t?t+" "+m:m;return{...o,name:r,type:m,tonic:t,notes:a}}const Se={major:[],lydian:["4A"],mixolydian:["7m"],minor:[],dorian:["6M"],phrygian:["2m"],locrian:["2m","5d"],"harmonic minor":["7M"],"melodic minor":["6M","7M"],"major pentatonic":[],"minor pentatonic":["7m"],blues:["3m","5d","7m"],"lydian dominant":["4A","7m"],"phrygian dominant":["2m","3M","7m"]},we={major:"基础的大调音阶，明亮、开朗、稳定。广泛用于各种音乐。",lydian:"比大调更明亮、梦幻，带有#4（增四度）特色音。常用于电影配乐、爵士乐（尤其在Maj7#11和弦上）。",mixolydian:"具有属功能（Dominant）感觉，因为包含小七度(b7)。布鲁斯、摇滚、放克和乡村音乐中常见，常用于属七和弦。",minor:"自然小调，忧郁、悲伤的基调。",dorian:"比自然小调略明亮（因含大六度(6)），带有爵士、民谣或轻微布鲁斯感。常用于爵士乐的 ii-V-I 进行中的 IIm7 和弦。",phrygian:"非常黑暗、具有西班牙/弗拉门戈/中东风情，特色是降二级(b2)。金属乐中也常用。",locrian:"最不稳定、最不协和的调式，包含减五度(b5)。很少作为中心调式，常作为经过或特殊效果。","harmonic minor":"具有鲜明的中东或古典色彩，因其增二度（bVI到VII之间）和导音（大七度(7)）。常用于小调的属和弦（V7）。","melodic minor":"上行时比自然小调明亮（大六(6)、大七(7)），下行时通常还原为自然小调。爵士乐中常用其上行形式（爵士小调）。","major pentatonic":"非常悦耳、开放、常用于民谣、乡村、亚洲音乐。缺少半音使其听起来和谐。","minor pentatonic":"布鲁斯、摇滚乐的基础，声音粗犷、有力。缺少二度和六度。",blues:"在小调五声音阶基础上加入降五度（b5，“蓝调音符”），有时也包含大三度，非常有特色，布鲁斯音乐的核心。","lydian dominant":"Mixolydian 的 #4 版本，既有属功能（b7）又有 Lydian 的明亮感（#4）。常用于爵士乐中的替代属和弦 (Sub V7) 或 Tritone Substitution。","phrygian dominant":"和声小调的第五个模式，具有强烈的西班牙/中东/犹太音乐风味（b2, M3, b7）。"},Te=["C4","Db4","D4","Eb4","E4","F4","Gb4","G4","Ab4","A4","Bb4","B4"];let s=[];function $e(e){const n={tonicInput:e.querySelector("#tonic-input"),scaleSelect:e.querySelector("#scale-select"),clefSelect:e.querySelector("#scale-clef-select"),generateButton:e.querySelector("#generate-scale-button"),randomizeButton:e.querySelector("#randomize-scale-button"),notesOutput:e.querySelector("#scale-notes-output"),usageOutput:e.querySelector("#scale-usage-output"),scoreOutputContainer:e.querySelector("#scale-score-output"),vexFlowTargetId:"scale-explorer-vexflow-output"};return Object.values(n).some(t=>t==null)?(console.error("ScaleExplorer Error: 找不到所需的 UI 元素。 Check IDs like #randomize-scale-button and #scale-usage-output."),null):(n.vexFlowContainer=()=>e.querySelector(`#${n.vexFlowTargetId}`),n)}function Ne(e){if(!e||(e.innerHTML="",s=je(),!s||s.length===0))return;s.sort(),s.forEach(t=>{const o=document.createElement("option");o.value=t,o.textContent=t,e.appendChild(o)});const n="major";s.includes(n)?e.value=n:s.length>0&&(e.value=s[0]),e.disabled=!1,console.log(`Scale select populated with ${s.length} scales.`)}function Ce(e){if(!e||e.length===0)return[];let n=null;return e.map(t=>{const o=x(t);if(o.empty)return console.warn(`无法解析音符: ${t}，跳过。`),null;let m=o.oct;return m==null&&(n===null&&(n=4,console.log("根音未提供八度，渲染时默认使用八度 4")),m=n),{keys:[`${o.pc.toLowerCase().replace("b","b").replace("#","#")}/${m}`],duration:"q"}}).filter(t=>t!==null)}function $(e,n,t){const o=Math.max(300,e.length*50+60);return{elementId:t,width:o,height:150,staves:[{clef:n,notes:e}]}}function u(e,n){e?e.innerHTML=`<p style="color: red; padding: 10px;">错误: ${n}</p>`:console.error("错误显示失败: 容器无效。",n)}function Ee(e){if(!e||e.empty||!e.type||!e.tonic)return[];const n=Se[e.type]||[],t=e.tonic;return n.map(o=>{try{const m=x(t).oct===null?e.notes[0]||"C4":t;let a=J(m,o);if(x(a).oct===null){const r=j(a),i=e.notes.find(p=>j(p)===r);i&&(a=i)}return a}catch(m){return console.warn(`Error transposing tonic ${t} by interval ${o}:`,m),null}}).filter(o=>o!==null&&e.notes.includes(o))}function E(e){const{tonicInput:n,scaleSelect:t,clefSelect:o,notesOutput:m,usageOutput:a,scoreOutputContainer:r,vexFlowTargetId:i,vexFlowContainer:p}=e;m.innerHTML="<p>...</p>",a.innerHTML="<p>...</p>",r.innerHTML=`<div id="${i}"></div>`;const P=p();if(!P){u(r,"无法创建 VexFlow 渲染目标。");return}const h=n.value.trim(),v=t.value,S=o.value;if(!h||!v){u(P,"请输入根音并选择音阶类型。"),a.innerHTML="<p>-</p>",m.innerHTML="<p>-</p>";const l=$([],S,i);T(l.elementId,l);return}try{const l=`${h} ${v}`,d=z(l);if(d.empty){const M=z(v);let b=`无法获取音阶 "${l}". `;M.empty?b+=`无效的音阶类型: "${v}"`:x(h).empty?b+=`无法识别的根音: "${h}"。`:b+="请检查输入。",u(P,b),a.innerHTML="<p>-</p>",m.innerHTML="<p>-</p>";const g=$([],S,i);T(g.elementId,g);return}const K=Ee(d),Q=we[d.type]||"暂无该调式的建议信息。",W=d.notes.map(M=>K.some(g=>j(g)===j(M))?`<span class="characteristic-note">${M}</span>`:M).join(" ");m.innerHTML=`<pre><code>${W}</code></pre>`,a.innerHTML=`<p>${Q}</p>`;const w=Ce(d.notes);if(w.length===0&&d.notes.length>0)u(P,"成功获取音阶音符，但在转换为 VexFlow 格式时出错。");else if(w.length===0)u(P,"音阶不包含可渲染的音符。");else{const M=$(w,S,i);T(M.elementId,M),console.log(`音阶 "${l}" 渲染成功 (incl. enhancements).`)}}catch(l){console.error("处理音阶生成请求时发生错误:",l),u(P,`生成音阶时出错: ${l.message}`),a.innerHTML="<p>-</p>",m.innerHTML="<p>-</p>"}}function Ie(e){const{tonicInput:n,scaleSelect:t}=e;if(!s||s.length===0){console.error("Cannot randomize: Scale names not available."),alert("音阶列表尚未加载完成，无法随机。");return}const o=I(Te)[0],m=I(s)[0];n.value=o,t.value=m,E(e),console.log(`Randomized to: ${o} ${m}`)}function Le(e){e.generateButton.addEventListener("click",()=>E(e)),e.randomizeButton.addEventListener("click",()=>Ie(e))}function ze(e){if(!e){console.error("ScaleExplorer 初始化失败: 未提供容器元素。");return}e.innerHTML=Y;const n=$e(e);n&&(Ne(n.scaleSelect),Le(n),E(n),console.log("Scale Explorer 工具已初始化 (with enhancements)."))}export{ze as initializeScaleExplorer};
